<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mission HQ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --yellow: #F5C518;
  --pink: #FF3C3C;
  --green: #2E7D32;
  --blue: #1565C0;
  --purple: #7B1FA2;
  --orange: #EF6C00;
  --red: #C62828;
  --gold: #B8860B;
  --gold-light: #F5C518;
  --bg: #F5F0E8;
  --card-bg: #fff;
  --card-border: #E0D6C8;
  --text: #1a1a2e;
  --text-muted: #666;
  --card-shadow: 0 4px 16px rgba(0,0,0,0.08);
  --card-radius: 12px;
  --transition: all 0.3s ease;
}

body {
  font-family: 'Rajdhani', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg);
  min-height: 100vh;
  color: var(--text);
  overflow-x: hidden;
}

h1, h2, h3, .nav-tab, .parent-tab, .btn, .kid-card .name, .day-header .day-name,
.task-points, .points-badge, .reward-card .cost {
  font-family: 'Orbitron', monospace;
}

.screen { display: none; min-height: 100vh; padding: 20px; max-width: 600px; margin: 0 auto; position: relative; }
.screen.active { display: block; }
.screen.wide { max-width: 900px; }

/* Login Screen */
#login-screen {
  background: linear-gradient(160deg, #FFF8E7 0%, #FFF0D0 40%, #FDEBD0 100%);
  display: none; flex-direction: column; align-items: center; justify-content: center;
  text-align: center;
}
#login-screen.active { display: flex; }

#login-screen h1 { font-size: 1.6rem; margin-bottom: 8px; color: var(--red); letter-spacing: 2px; text-transform: uppercase; }
#login-screen .subtitle { font-size: 1rem; color: var(--text-muted); margin-bottom: 30px; letter-spacing: 2px; text-transform: uppercase; }

.kid-cards { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin-bottom: 30px; }

.kid-card {
  background: var(--card-bg); border: 2px solid var(--card-border); border-radius: var(--card-radius); padding: 24px 32px;
  box-shadow: var(--card-shadow); cursor: pointer; transition: var(--transition);
  min-width: 140px; text-align: center;
}
.kid-card:hover { transform: translateY(-5px) scale(1.03); box-shadow: 0 8px 30px rgba(198,40,40,0.15); border-color: var(--red); }
.kid-card:active { transform: scale(0.97); }
.kid-card .avatar { font-size: 4rem; display: block; margin-bottom: 8px; }
.kid-card .avatar-img.large { margin-bottom: 8px; border: 3px solid var(--gold); }
.kid-card .name { font-size: 1.1rem; font-weight: 700; color: var(--red); letter-spacing: 1px; }

.parent-login-btn {
  background: transparent; border: 2px solid var(--card-border); border-radius: 12px;
  padding: 12px 24px; font-size: 0.9rem; cursor: pointer; color: var(--text-muted);
  transition: var(--transition); letter-spacing: 1px; text-transform: uppercase;
}
.parent-login-btn:hover { border-color: var(--red); color: var(--red); }

/* Welcome Screen */
#welcome-screen {
  background: linear-gradient(160deg, #FFF8E7 0%, #FFF0D0 40%, #FDEBD0 100%);
  display: none; flex-direction: column; align-items: center; justify-content: center;
  text-align: center; min-height: 100vh;
}
#welcome-screen.active { display: flex; }
#welcome-screen h1 { font-size: 2.2rem; color: var(--red); letter-spacing: 3px; text-transform: uppercase; margin-bottom: 4px; }
#welcome-screen .welcome-subtitle { font-size: 1rem; color: var(--text-muted); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 40px; }
#welcome-screen .welcome-icon { font-size: 4rem; margin-bottom: 16px; }
.welcome-options { display: flex; flex-direction: column; gap: 16px; width: 100%; max-width: 340px; }
.welcome-card {
  background: var(--card-bg); border: 2px solid var(--card-border); border-radius: var(--card-radius);
  padding: 24px; box-shadow: var(--card-shadow); cursor: pointer; transition: var(--transition);
  text-align: center;
}
.welcome-card:hover { transform: translateY(-3px); box-shadow: 0 8px 30px rgba(198,40,40,0.15); border-color: var(--red); }
.welcome-card:active { transform: scale(0.97); }
.welcome-card .card-icon { font-size: 2.5rem; margin-bottom: 8px; display: block; }
.welcome-card .card-title { font-family: 'Orbitron', monospace; font-size: 1rem; font-weight: 700; color: var(--red); letter-spacing: 1px; margin-bottom: 4px; }
.welcome-card .card-desc { font-size: 0.9rem; color: var(--text-muted); }

/* Setup Screen */
#setup-screen {
  background: linear-gradient(160deg, #FFF8E7 0%, #FFF0D0 40%, #FDEBD0 100%);
  display: none; flex-direction: column; align-items: center; justify-content: center;
  text-align: center;
}
#setup-screen.active { display: flex; }

.setup-section { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: var(--card-radius); padding: 24px; margin: 16px 0; width: 100%; max-width: 400px; box-shadow: var(--card-shadow); }
.setup-section h2 { margin-bottom: 12px; font-size: 1.3rem; color: var(--red); }
.setup-section input[type="text"] {
  width: 100%; padding: 12px; border: 2px solid var(--card-border); border-radius: 10px;
  font-size: 1rem; margin-bottom: 12px; outline: none; background: #fff; color: var(--text);
}
.setup-section input[type="text"]:focus { border-color: var(--gold); }


.avatar-grid {
  display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-bottom: 12px;
}
.avatar-option {
  font-size: 2rem; padding: 8px; border-radius: 10px; cursor: pointer;
  border: 3px solid transparent; transition: var(--transition); background: #f5f0e8;
  text-align: center;
}
.avatar-option:hover { background: #f0e6d6; }
.avatar-option.selected { border-color: var(--gold); background: #FFF8E7; }

.btn {
  display: inline-block; padding: 14px 28px; border: none; border-radius: 10px;
  font-size: 0.95rem; font-weight: 700; cursor: pointer; transition: var(--transition);
  color: #fff; min-width: 120px; text-align: center; letter-spacing: 1px; text-transform: uppercase;
}
.btn:hover { transform: translateY(-2px); }
.btn:active { transform: scale(0.97); }
.btn-blue { background: var(--blue); }
.btn-green { background: var(--green); color: #fff; }
.btn-pink { background: var(--red); }
.btn-orange { background: var(--orange); color: #fff; }
.btn-purple { background: var(--purple); }
.btn-gray { background: #ddd; color: #555; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

/* Kid Home */
#kid-home, #kid-weekly, #kid-extra, #kid-rewards {
  background: linear-gradient(160deg, #FFF8E7, #FDEBD0);
}

.top-bar {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 20px;
}
.top-bar .greeting { font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 8px; color: var(--text); }
.top-bar .greeting .avatar-img.small { display: inline-block; vertical-align: middle; border: 2px solid var(--gold); }
.top-bar .greeting .avatar-emoji.small { display: inline; }
.top-bar .points-badge {
  background: #fff; border: 2px solid var(--gold); border-radius: 30px; padding: 8px 18px;
  font-weight: 700; font-size: 0.85rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  display: flex; align-items: center; gap: 6px; color: var(--gold);
}
.points-anim { animation: pointsPop 0.4s ease; }
@keyframes pointsPop { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }

.nav-tabs {
  display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;
}
.nav-tab {
  padding: 10px 18px; border-radius: 8px; font-weight: 600; cursor: pointer;
  border: 1px solid var(--card-border); font-size: 0.75rem; transition: var(--transition);
  background: var(--card-bg); color: var(--text-muted); letter-spacing: 1px; text-transform: uppercase;
}
.nav-tab.active { background: var(--red); color: #fff; border-color: var(--red); box-shadow: 0 2px 10px rgba(198,40,40,0.2); }
.nav-tab:hover { border-color: var(--red); color: var(--red); }

.task-list { display: flex; flex-direction: column; gap: 12px; }

.task-item {
  background: var(--card-bg); border: 1px solid var(--card-border); border-radius: var(--card-radius); padding: 16px 20px;
  box-shadow: var(--card-shadow); display: flex; align-items: center; gap: 14px;
  transition: var(--transition); cursor: pointer; min-height: 60px;
}
.task-item:hover { transform: translateX(4px); border-color: var(--gold); }
.task-item.completed { opacity: 0.6; border-color: var(--green); }
.task-item.completed .task-title { text-decoration: line-through; color: var(--green); }

.task-check {
  width: 32px; height: 32px; border-radius: 50%; border: 3px solid var(--card-border);
  display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  font-size: 1.1rem; transition: var(--transition);
}
.task-item.completed .task-check { background: var(--green); border-color: var(--green); color: #fff; }
.task-item.pending-approval .task-check { background: var(--orange); border-color: var(--orange); color: #fff; }

.task-info { flex: 1; }
.task-title { font-weight: 600; font-size: 1rem; color: var(--text); }
.task-meta { font-size: 0.8rem; color: var(--text-muted); margin-top: 2px; }
.task-points { font-weight: 700; color: var(--gold); font-size: 0.85rem; white-space: nowrap; }

.claim-btn, .didit-btn {
  padding: 8px 14px; border-radius: 8px; border: none; font-weight: 700;
  cursor: pointer; font-size: 0.75rem; transition: var(--transition);
  letter-spacing: 1px; text-transform: uppercase; font-family: 'Orbitron', monospace;
}
.claim-btn { background: var(--red); color: #fff; }
.didit-btn { background: var(--gold); color: #fff; }
.claim-btn:hover, .didit-btn:hover { transform: scale(1.05); }

.section-label {
  font-size: 0.8rem; font-weight: 700; color: var(--red); text-transform: uppercase;
  letter-spacing: 2px; margin: 16px 0 8px; font-family: 'Orbitron', monospace;
}

.logout-btn {
  position: absolute; top: 20px; right: 20px; background: #e8e0d4;
  border: none; border-radius: 8px; padding: 8px 14px; cursor: pointer;
  font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;
}

/* Rewards Shop */
.rewards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 14px; }

.reward-card {
  background: var(--card-bg); border: 1px solid var(--card-border); border-radius: var(--card-radius); padding: 20px;
  box-shadow: var(--card-shadow); text-align: center; transition: var(--transition);
}
.reward-card:hover { transform: translateY(-3px); border-color: var(--gold); }
.reward-card .emoji { font-size: 3rem; display: block; margin-bottom: 8px; }
.reward-card .title { font-weight: 700; margin-bottom: 6px; color: var(--text); }
.reward-card .cost { color: var(--gold); font-weight: 700; margin-bottom: 10px; font-size: 0.85rem; }
.reward-card .btn { padding: 8px 16px; font-size: 0.7rem; min-width: 0; width: 100%; }

/* Parent Dashboard */
#parent-dashboard {
  background: linear-gradient(160deg, #F5F0E8, #FDEBD0);
  padding-bottom: 40px;
}

.parent-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.parent-header h1 { font-size: 1.3rem; color: var(--red); letter-spacing: 2px; }

.parent-tabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
.parent-tab {
  padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer;
  border: 1px solid var(--card-border); font-size: 0.75rem; transition: var(--transition);
  background: var(--card-bg); color: var(--text-muted); letter-spacing: 1px; text-transform: uppercase;
  font-family: 'Orbitron', monospace;
}
.parent-tab.active { background: var(--red); color: #fff; border-color: var(--red); }

.parent-section { display: none; }
.parent-section.active { display: block; }

.kid-progress-card {
  background: var(--card-bg); border: 1px solid var(--card-border); border-radius: var(--card-radius); padding: 20px;
  box-shadow: var(--card-shadow); margin-bottom: 16px;
}
.kid-progress-card h3 { margin-bottom: 12px; display: flex; align-items: center; gap: 8px; color: var(--text); }
.weekly-grid-card h3 { display: flex; align-items: center; gap: 8px; color: var(--text); }
.approval-item .label { display: flex; align-items: center; gap: 6px; }
.progress-bar-wrap {
  background: #e8e0d4; border-radius: 10px; height: 14px; overflow: hidden; margin: 8px 0;
}
.progress-bar-fill {
  height: 100%; border-radius: 10px; transition: width 0.5s ease;
  background: linear-gradient(90deg, var(--green), var(--gold));
}
.stat-row { display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--text-muted); margin-top: 4px; }

/* Weekly Grid Table */
.weekly-grid-card {
  background: var(--card-bg); border: 1px solid var(--card-border); border-radius: var(--card-radius); padding: 20px;
  box-shadow: var(--card-shadow); margin-bottom: 16px; overflow-x: auto;
}
.weekly-grid-card h3 { margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }

.weekly-grid {
  width: 100%; border-collapse: collapse; font-size: 0.85rem;
}
.weekly-grid th {
  padding: 8px 6px; text-align: center; font-weight: 700; font-size: 0.75rem;
  color: var(--text-muted); text-transform: uppercase; border-bottom: 2px solid var(--card-border);
}
.weekly-grid th.today { color: var(--red); }
.weekly-grid th:first-child { text-align: left; min-width: 120px; }
.weekly-grid td {
  padding: 8px 6px; text-align: center; border-bottom: 1px solid var(--card-border);
}
.weekly-grid td:first-child { text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text); }
.weekly-grid td .pts-label { font-size: 0.7rem; color: var(--text-muted); font-weight: 400; }
.weekly-grid .check-done { color: var(--green); font-size: 1.2rem; }
.weekly-grid .check-pending { color: var(--orange); font-size: 1rem; }
.weekly-grid .check-miss { color: #ccc; font-size: 1rem; }
.weekly-grid tr:last-child td { border-bottom: none; }

.week-nav {
  display: flex; align-items: center; gap: 12px; margin-bottom: 14px;
}
.week-nav button {
  background: #e8e0d4; border: none; border-radius: 8px; padding: 6px 12px;
  cursor: pointer; font-size: 1rem; transition: var(--transition); color: var(--text);
}
.week-nav button:hover { background: #ddd6c8; }
.week-nav .week-label { font-weight: 600; font-size: 0.95rem; color: var(--text); }

.crud-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 16px; }

.crud-item {
  background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 12px; padding: 14px 16px;
  box-shadow: var(--card-shadow); display: flex; align-items: center;
  gap: 10px;
}
.crud-item .info { flex: 1; }
.crud-item .info .label { font-weight: 600; color: var(--text); }
.crud-item .info .meta { font-size: 0.8rem; color: var(--text-muted); }
.crud-item .actions { display: flex; gap: 6px; }
.icon-btn {
  width: 36px; height: 36px; border-radius: 10px; border: none; cursor: pointer;
  font-size: 1.1rem; display: flex; align-items: center; justify-content: center;
  transition: var(--transition);
}
.icon-btn:hover { transform: scale(1.1); }
.icon-btn.edit { background: rgba(21,101,192,0.1); }
.icon-btn.delete { background: rgba(198,40,40,0.1); }

.approval-item {
  background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 12px; padding: 14px 16px;
  box-shadow: var(--card-shadow); display: flex; align-items: center;
  gap: 10px; margin-bottom: 10px;
}
.approval-item .info { flex: 1; }
.approval-item .actions { display: flex; gap: 6px; }

/* Modal */
.modal-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.4); display: none; align-items: center;
  justify-content: center; z-index: 100; padding: 20px;
}
.modal-overlay.show { display: flex; }

.modal {
  background: #fff; border-radius: var(--card-radius); padding: 28px;
  max-width: 420px; width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
  animation: modalIn 0.3s ease;
  max-height: 90vh; overflow-y: auto;
}
@keyframes modalIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

.modal h2 { margin-bottom: 16px; }
.modal label { display: block; font-weight: 600; margin-bottom: 4px; margin-top: 12px; font-size: 0.9rem; }
.modal input[type="text"], .modal input[type="number"], .modal select {
  width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 10px;
  font-size: 1rem; outline: none;
}
.modal input[type="text"]:focus, .modal input[type="number"]:focus, .modal select:focus { border-color: var(--blue); }
.modal .btn-row { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }

/* Bonus History */
.bonus-history { margin-top: 10px; }
.bonus-history-item {
  display: flex; justify-content: space-between; align-items: center;
  padding: 6px 10px; background: #FFF8E7; border-radius: 8px; margin-top: 6px;
  font-size: 0.85rem; border: 1px solid #f0e6d6;
}
.bonus-history-item .bonus-reason { color: var(--text); font-weight: 600; }
.bonus-history-item .bonus-pts { color: var(--gold); font-weight: 700; font-family: 'Orbitron', monospace; font-size: 0.8rem; }

/* PIN Modal */
.pin-input {
  display: flex; gap: 10px; justify-content: center; margin: 20px 0;
}
.pin-input input {
  width: 50px; height: 60px; text-align: center; font-size: 1.5rem; font-weight: 700;
  border: 2px solid #ddd; border-radius: 12px;
}
.pin-input input:focus { border-color: var(--blue); }
.pin-error { color: var(--pink); text-align: center; font-size: 0.9rem; min-height: 1.2em; }

/* Confetti */
.confetti-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 200; }
.confetti-piece {
  position: absolute; width: 10px; height: 10px; top: -10px;
  animation: confettiFall 1.5s ease-in forwards;
}
@keyframes confettiFall {
  0% { transform: translateY(0) rotate(0deg); opacity: 1; }
  100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
}

/* Celebration overlay */
.celebration {
  position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
  font-size: 3rem; font-weight: 900; color: var(--green);
  text-shadow: 0 2px 10px rgba(0,0,0,0.1);
  animation: celebPop 0.8s ease forwards; pointer-events: none; z-index: 201;
  white-space: nowrap;
}
@keyframes celebPop {
  0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
  50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
  100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
}

/* Checkbox toggle for approval */
.toggle-wrap { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
.toggle-wrap input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }

/* Empty states */
.empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
.empty-state .emoji { font-size: 3rem; display: block; margin-bottom: 12px; }

/* Inline points editor */
.inline-points {
  width: 50px; padding: 4px 6px; border: 2px solid #ddd; border-radius: 8px;
  font-size: 0.85rem; font-weight: 700; text-align: center; color: var(--blue);
  outline: none;
}
.inline-points:focus { border-color: var(--blue); }

/* Responsive */
@media (max-width: 400px) {
  .kid-cards { flex-direction: column; align-items: center; }
  .avatar-grid { grid-template-columns: repeat(4, 1fr); }
  .nav-tabs { gap: 4px; }
  .nav-tab { padding: 8px 12px; font-size: 0.85rem; }
  .rewards-grid { grid-template-columns: repeat(2, 1fr); }
  .weekly-grid { font-size: 0.75rem; }
  .weekly-grid th, .weekly-grid td { padding: 6px 3px; }
}

/* Avatar images */
.avatar-img {
  width: 64px; height: 64px; border-radius: 50%; object-fit: cover;
  display: block; margin: 0 auto;
}
.avatar-img.small { width: 32px; height: 32px; }
.avatar-img.large { width: 80px; height: 80px; }
.avatar-emoji { font-size: 4rem; display: block; }
.avatar-emoji.small { font-size: 1.5rem; }

.avatar-upload-wrap {
  display: flex; align-items: center; gap: 12px; margin-bottom: 12px;
  justify-content: center;
}
.avatar-upload-btn {
  background: var(--blue); color: #fff; border: none; border-radius: 10px;
  padding: 8px 16px; font-size: 0.85rem; font-weight: 600; cursor: pointer;
  transition: var(--transition);
}
.avatar-upload-btn:hover { transform: translateY(-2px); }
.avatar-upload-preview {
  width: 50px; height: 50px; border-radius: 50%; object-fit: cover;
  border: 3px solid var(--blue); display: none;
}
.avatar-upload-preview.show { display: block; }
.avatar-or { font-size: 0.8rem; color: #999; text-align: center; margin-bottom: 8px; }

/* Day header */
.day-header {
  font-size: 1.1rem; font-weight: 700; color: var(--text-muted);
}
.day-header .day-name { font-size: 1.3rem; color: var(--text); }

.daily-summary {
  background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 12px; padding: 12px 16px;
  display: flex; justify-content: space-between; align-items: center;
  font-size: 0.9rem; color: var(--text-muted);
}
.daily-summary .earned { color: var(--green); font-weight: 700; }
.daily-summary .possible { color: var(--blue); font-weight: 600; }

/* Scrollable body padding for bottom bar */
#kid-home, #kid-weekly, #kid-extra, #kid-rewards { padding-bottom: 40px; }
@keyframes pulse { 0%,100%{opacity:0.4;transform:scale(0.95)} 50%{opacity:1;transform:scale(1.05)} }
.conn-banner{position:fixed;top:0;left:0;right:0;padding:6px 12px;text-align:center;font-size:0.8rem;z-index:9999;font-family:'Rajdhani',sans-serif;font-weight:600;transition:transform 0.3s ease}
.conn-banner.offline{background:var(--red);color:#fff;transform:translateY(0)}
.conn-banner.online{background:var(--green);color:#fff;transform:translateY(0)}
.conn-banner.hidden{transform:translateY(-100%)}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div id="conn-banner" class="conn-banner hidden"></div>

<!-- Loading Screen -->
<div id="loading-screen" class="screen active">
  <div style="text-align:center;padding-top:120px">
    <div style="font-size:3rem;margin-bottom:16px;animation:pulse 1.5s ease-in-out infinite">üõ∞Ô∏è</div>
    <h1 style="font-size:1.3rem;margin-bottom:8px;color:var(--cyan)">Connecting to Mission HQ...</h1>
    <p style="color:var(--text-muted);font-size:0.9rem" id="loading-status">Establishing secure link</p>
  </div>
</div>

<!-- Welcome Screen -->
<div id="welcome-screen" class="screen">
  <div class="welcome-icon">üöÄ</div>
  <h1>Go Get Em Done</h1>
  <p class="welcome-subtitle" style="max-width:340px;line-height:1.4">Complete missions, earn points, and unlock awesome rewards!</p>
  <div class="welcome-options">
    <div class="welcome-card" onclick="renderSetup()">
      <span class="card-icon">üöÄ</span>
      <div class="card-title">New Recruits</div>
      <div class="card-desc">Set up your family's mission base</div>
    </div>
    <div class="welcome-card" onclick="showFamilyCodeEntry()">
      <span class="card-icon">üîë</span>
      <div class="card-title">Returning Agents</div>
      <div class="card-desc">Enter your family code to rejoin</div>
    </div>
  </div>
  <p style="font-size:0.85rem;color:var(--text-muted);margin-top:24px;letter-spacing:1px">A fun way to track chores and earn rewards</p>
  <div id="family-code-entry" style="display:none;margin-top:24px;text-align:center;width:100%;max-width:340px">
    <input type="text" id="family-code-input" placeholder="6-char code"
           maxlength="6" style="text-transform:uppercase;text-align:center;font-size:1.2rem;letter-spacing:4px;width:100%;padding:12px;border:2px solid var(--card-border);border-radius:10px;font-family:'Orbitron',monospace;background:#fff;color:var(--text);outline:none">
    <div style="display:flex;gap:12px;justify-content:center;margin-top:12px">
      <button class="btn btn-gray" onclick="hideFamilyCodeEntry()">Cancel</button>
      <button class="btn btn-blue" onclick="joinFamily()">Join Mission</button>
    </div>
    <p id="family-code-error" style="color:var(--red);font-size:0.85rem;margin-top:8px;display:none"></p>
  </div>
</div>

<!-- Login Screen -->
<div id="login-screen" class="screen">
  <h1 id="login-title">Mission HQ</h1>
  <p class="subtitle">Select your agent to begin!</p>
  <div class="kid-cards" id="login-kid-cards"></div>
  <button class="parent-login-btn" onclick="showPinModal('login')">HQ Access</button>
</div>

<!-- Connection Error Screen -->
<div id="error-screen" class="screen">
  <div style="text-align:center;padding-top:80px">
    <div style="font-size:4rem;margin-bottom:16px">üì°</div>
    <h1 style="color:var(--red);font-size:1.5rem;margin-bottom:12px">Connection Lost</h1>
    <p style="color:var(--text-muted);margin-bottom:8px">Could not reach Mission HQ database.</p>
    <p style="color:var(--text-muted);margin-bottom:24px;font-size:0.9rem">Your data is safe ‚Äî check your internet connection and try again.</p>
    <button class="btn btn-blue" onclick="location.reload()" style="margin-bottom:12px">Retry Connection</button>
    <div id="error-backup-msg" style="display:none;margin-top:16px">
      <p style="color:var(--text-muted);margin-bottom:8px;font-size:0.9rem">A local backup was found. You can use it in read-only mode:</p>
      <button class="btn btn-orange" onclick="loadFromBackup()">Use Local Backup</button>
    </div>
  </div>
</div>

<!-- Setup Screen -->
<div id="setup-screen" class="screen">
  <h1>Mission Briefing</h1>
  <div class="setup-section">
    <h2>Family Name</h2>
    <input type="text" id="setup-household" placeholder="e.g. Kusmich">
    <p style="font-size:0.8rem;color:var(--text-muted);margin-top:-4px">Your base will be called "The Kusmich Basecamp"</p>
  </div>
  <div id="setup-kids-container"></div>
  <button class="btn btn-orange" onclick="addSetupKid()" style="margin-top:8px;padding:10px 20px;font-size:0.8rem">+ Add Another Agent</button>
  <div class="setup-section">
    <h2>HQ Access Code</h2>
    <input type="text" id="setup-pin" placeholder="4-digit code" maxlength="4" inputmode="numeric">
  </div>
  <div style="display:flex;gap:12px;margin-top:16px">
    <button class="btn btn-gray" onclick="showScreen('welcome-screen')">Back</button>
    <button class="btn btn-blue" onclick="completeSetup()">Launch Mission!</button>
  </div>
</div>

<!-- Kid Home (Daily Tasks) -->
<div id="kid-home" class="screen">
  <button class="logout-btn" onclick="logout()">Log out</button>
  <div class="top-bar">
    <div class="greeting" id="kid-greeting"></div>
    <div class="points-badge" id="kid-points"></div>
  </div>
  <div id="kid-day-header" style="margin-bottom:12px"></div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="showKidTab('daily')">Daily</button>
    <button class="nav-tab" onclick="showKidTab('weekly')">Weekly</button>
    <button class="nav-tab" onclick="showKidTab('extra')">Extra</button>
    <button class="nav-tab" onclick="showKidTab('rewards')">Rewards</button>
  </div>
  <div id="kid-daily-summary" style="margin-bottom:14px"></div>
  <div id="daily-tasks" class="task-list"></div>
</div>

<!-- Kid Weekly Tasks -->
<div id="kid-weekly" class="screen">
  <button class="logout-btn" onclick="logout()">Log out</button>
  <div class="top-bar">
    <div class="greeting" id="kid-greeting-w"></div>
    <div class="points-badge" id="kid-points-w"></div>
  </div>
  <div class="nav-tabs">
    <button class="nav-tab" onclick="showKidTab('daily')">Daily</button>
    <button class="nav-tab active" onclick="showKidTab('weekly')">Weekly</button>
    <button class="nav-tab" onclick="showKidTab('extra')">Extra</button>
    <button class="nav-tab" onclick="showKidTab('rewards')">Rewards</button>
  </div>
  <div id="weekly-task-sections"></div>
</div>

<!-- Kid Extra Missions -->
<div id="kid-extra" class="screen">
  <button class="logout-btn" onclick="logout()">Log out</button>
  <div class="top-bar">
    <div class="greeting" id="kid-greeting-e"></div>
    <div class="points-badge" id="kid-points-e"></div>
  </div>
  <div class="nav-tabs">
    <button class="nav-tab" onclick="showKidTab('daily')">Daily</button>
    <button class="nav-tab" onclick="showKidTab('weekly')">Weekly</button>
    <button class="nav-tab active" onclick="showKidTab('extra')">Extra</button>
    <button class="nav-tab" onclick="showKidTab('rewards')">Rewards</button>
  </div>
  <div id="extra-task-sections"></div>
</div>

<!-- Kid Rewards Shop -->
<div id="kid-rewards" class="screen">
  <button class="logout-btn" onclick="logout()">Log out</button>
  <div class="top-bar">
    <div class="greeting" id="kid-greeting-r"></div>
    <div class="points-badge" id="kid-points-r"></div>
  </div>
  <div class="nav-tabs">
    <button class="nav-tab" onclick="showKidTab('daily')">Daily</button>
    <button class="nav-tab" onclick="showKidTab('weekly')">Weekly</button>
    <button class="nav-tab" onclick="showKidTab('extra')">Extra</button>
    <button class="nav-tab active" onclick="showKidTab('rewards')">Rewards</button>
  </div>
  <div class="rewards-grid" id="rewards-grid"></div>
</div>

<!-- Parent Dashboard -->
<div id="parent-dashboard" class="screen wide">
  <div class="parent-header">
    <div>
      <h1 id="parent-header-title">Command Center</h1>
      <div id="family-code-display" style="font-size:0.75rem;color:var(--text-muted);margin-top:-4px;letter-spacing:1px">
        Family Code: <strong id="family-code-value" style="letter-spacing:2px;color:var(--gold)"></strong>
      </div>
    </div>
    <button class="btn btn-gray" onclick="logout()" style="padding:8px 16px;font-size:0.9rem;min-width:0">Log out</button>
  </div>
  <div class="parent-tabs" id="parent-tabs-bar">
    <button class="parent-tab active" data-tab="overview" onclick="showParentTab('overview', this)">Overview</button>
    <button class="parent-tab" data-tab="tasks" onclick="showParentTab('tasks', this)">Missions</button>
    <button class="parent-tab" data-tab="rewards" onclick="showParentTab('rewards', this)">Rewards</button>
    <button class="parent-tab" data-tab="approvals" onclick="showParentTab('approvals', this)">Approvals</button>
    <button class="parent-tab" data-tab="history" onclick="showParentTab('history', this)">History</button>
  </div>

  <div id="parent-overview" class="parent-section active"></div>
  <div id="parent-tasks" class="parent-section"></div>
  <div id="parent-rewards" class="parent-section"></div>
  <div id="parent-approvals" class="parent-section"></div>
  <div id="parent-history" class="parent-section"></div>
</div>

<!-- PIN Modal -->
<div class="modal-overlay" id="pin-modal">
  <div class="modal" style="text-align:center">
    <h2>Enter HQ Access Code</h2>
    <div class="pin-input">
      <input type="password" maxlength="1" inputmode="numeric" data-pin="0">
      <input type="password" maxlength="1" inputmode="numeric" data-pin="1">
      <input type="password" maxlength="1" inputmode="numeric" data-pin="2">
      <input type="password" maxlength="1" inputmode="numeric" data-pin="3">
    </div>
    <div class="pin-error" id="pin-error"></div>
    <div class="btn-row" style="justify-content:center">
      <button class="btn btn-gray" onclick="closePinModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Task Edit Modal -->
<div class="modal-overlay" id="task-modal">
  <div class="modal">
    <h2 id="task-modal-title">Add Task</h2>
    <input type="hidden" id="task-edit-id">
    <label>Title</label>
    <input type="text" id="task-edit-title" placeholder="e.g. Brush teeth">
    <label>Type</label>
    <select id="task-edit-type" onchange="toggleTimeOfDayField()">
      <option value="daily">Daily</option>
      <option value="weekly">Weekly</option>
      <option value="extra">Extra</option>
    </select>
    <div id="task-edit-daily-options">
      <label>Time of Day</label>
      <select id="task-edit-timeofday">
        <option value="morning">Morning</option>
        <option value="evening">Evening</option>
        <option value="anytime">Anytime</option>
      </select>
      <label>Which Days</label>
      <select id="task-edit-days">
        <option value="everyday">Every day</option>
        <option value="weekdays">Weekdays only (Mon‚ÄìFri)</option>
        <option value="weekends">Weekends only (Sat‚ÄìSun)</option>
      </select>
    </div>
    <div id="task-edit-extra-options" style="display:none">
      <label>Mission Style</label>
      <select id="task-edit-extra-mode" onchange="toggleExtraModeOptions()">
        <option value="individual">Individual (one kid at a time)</option>
        <option value="rotating">Rotating (first-come-first-serve)</option>
        <option value="team">Team (all agents get points)</option>
      </select>
      <label>Repeatable</label>
      <select id="task-edit-repeatable">
        <option value="once">One-time (removed after completion)</option>
        <option value="daily">Daily (resets each day)</option>
        <option value="weekly">Weekly (resets each week)</option>
      </select>
    </div>
    <label>Points</label>
    <input type="number" id="task-edit-points" value="5" min="0" max="100">
    <div id="task-edit-assigned-wrap">
      <label>Assigned To</label>
      <select id="task-edit-assigned"></select>
    </div>
    <div class="toggle-wrap">
      <input type="checkbox" id="task-edit-approval">
      <label for="task-edit-approval" style="margin:0">Requires parent approval</label>
    </div>
    <div class="btn-row">
      <button class="btn btn-gray" onclick="closeModal('task-modal')">Cancel</button>
      <button class="btn btn-blue" onclick="saveTask()">Save</button>
    </div>
  </div>
</div>

<!-- Reward Edit Modal -->
<div class="modal-overlay" id="reward-modal">
  <div class="modal">
    <h2 id="reward-modal-title">Add Reward</h2>
    <input type="hidden" id="reward-edit-id">
    <label>Title</label>
    <input type="text" id="reward-edit-title" placeholder="e.g. Extra screen time">
    <label>Emoji</label>
    <div class="avatar-grid" id="reward-emoji-grid" style="grid-template-columns:repeat(8,1fr);margin-top:6px;margin-bottom:0"></div>
    <label>Point Cost</label>
    <input type="number" id="reward-edit-cost" value="20" min="1" max="1000">
    <div class="btn-row">
      <button class="btn btn-gray" onclick="closeModal('reward-modal')">Cancel</button>
      <button class="btn btn-green" onclick="saveReward()">Save</button>
    </div>
  </div>
</div>

<!-- Bonus Grant Modal -->
<div class="modal-overlay" id="bonus-modal">
  <div class="modal">
    <h2>‚≠ê Grant Bonus Points</h2>
    <input type="hidden" id="bonus-kid-id">
    <p style="font-weight:600;font-size:1rem;margin-bottom:8px" id="bonus-kid-name"></p>
    <label>Points</label>
    <input type="number" id="bonus-points" value="5" min="1" max="100">
    <label>Reason</label>
    <input type="text" id="bonus-reason" placeholder="e.g. Helped neighbor, Extra kind today">
    <div class="btn-row">
      <button class="btn btn-gray" onclick="closeModal('bonus-modal')">Cancel</button>
      <button class="btn btn-green" onclick="grantBonusPoints()">Grant Points</button>
    </div>
  </div>
</div>

<!-- Deduct Stars Modal -->
<div class="modal-overlay" id="deduct-modal">
  <div class="modal">
    <h2 style="color:var(--red)">Remove Stars</h2>
    <input type="hidden" id="deduct-kid-id">
    <p style="font-weight:600;font-size:1rem;margin-bottom:8px" id="deduct-kid-name"></p>
    <label>Stars to remove</label>
    <input type="number" id="deduct-points" value="5" min="1" max="100">
    <label>Reason</label>
    <input type="text" id="deduct-reason" placeholder="e.g. Didn't listen, Broke a rule">
    <div class="btn-row">
      <button class="btn btn-gray" onclick="closeModal('deduct-modal')">Cancel</button>
      <button class="btn btn-pink" onclick="deductPoints()">Remove Stars</button>
    </div>
  </div>
</div>

<!-- Add Kid Modal -->
<div class="modal-overlay" id="add-kid-modal">
  <div class="modal">
    <h2>Add New Agent</h2>
    <label>Agent Name</label>
    <input type="text" id="add-kid-name" placeholder="Agent name">
    <label>Avatar</label>
    <div class="avatar-upload-wrap">
      <button class="avatar-upload-btn" onclick="document.getElementById('add-kid-photo').click()">Upload Photo</button>
      <img class="avatar-upload-preview" id="add-kid-preview">
      <input type="file" id="add-kid-photo" accept="image/*" style="display:none" onchange="handleAddKidPhoto(this)">
    </div>
    <div class="avatar-or">‚Äî or pick an emoji ‚Äî</div>
    <div class="avatar-grid" id="add-kid-avatars"></div>
    <div class="btn-row">
      <button class="btn btn-gray" onclick="closeModal('add-kid-modal')">Cancel</button>
      <button class="btn btn-green" onclick="addNewKid()">Add Agent</button>
    </div>
  </div>
</div>

<!-- Uncheck Confirmation Modal -->
<div class="modal-overlay" id="uncheck-modal">
  <div class="modal" style="text-align:center">
    <h2>Undo Task?</h2>
    <p id="uncheck-task-name" style="font-weight:600;margin-bottom:16px"></p>
    <p style="color:var(--text-muted);font-size:0.9rem;margin-bottom:20px">This will mark the task as incomplete and remove any points earned.</p>
    <div class="btn-row" style="justify-content:center">
      <button class="btn btn-gray" onclick="closeModal('uncheck-modal')">Cancel</button>
      <button class="btn btn-pink" onclick="confirmUncompleteTask()">Undo Task</button>
    </div>
  </div>
</div>

<!-- Confetti Container -->
<div class="confetti-container" id="confetti-container"></div>

<script>
// ============ DATA LAYER ============

const AVATARS = ['üê∂','üê±','üê∞','üêº','ü¶ä','üê®','ü¶Å','üê∏','üêµ','üêØ','ü¶Ñ','üê∑'];
const REWARD_EMOJIS = ['üç¶','üéÆ','üì∫','üé¨','üçï','üßÅ','üéØ','‚≠ê','üé™','üé®','üìö','üéµ','üèñÔ∏è','üéÅ','üç©','üõí'];
const DAY_NAMES = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

// Avatar helper: returns HTML for emoji or image avatar
function renderAvatar(avatar, size) {
  if (!avatar) return '';
  if (avatar.startsWith('data:')) {
    const cls = size === 'small' ? 'avatar-img small' : size === 'large' ? 'avatar-img large' : 'avatar-img';
    return `<img class="${cls}" src="${avatar}" alt="avatar">`;
  }
  const cls = size === 'small' ? 'avatar-emoji small' : 'avatar-emoji';
  return `<span class="${cls}">${avatar}</span>`;
}

// Photo upload: resize to 128x128 and store as base64
let uploadedPhotos = {};

function handlePhotoUpload(kidNum, input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      const size = 128;
      canvas.width = size;
      canvas.height = size;
      const ctx = canvas.getContext('2d');
      // Crop to square from center
      const min = Math.min(img.width, img.height);
      const sx = (img.width - min) / 2;
      const sy = (img.height - min) / 2;
      ctx.drawImage(img, sx, sy, min, min, 0, 0, size, size);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
      uploadedPhotos[kidNum] = dataUrl;
      // Show preview
      const preview = document.getElementById('setup-preview-' + kidNum);
      preview.src = dataUrl;
      preview.classList.add('show');
      // Deselect any emoji
      document.querySelectorAll(`#setup-avatars-${kidNum} .avatar-option`).forEach(a => a.classList.remove('selected'));
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// ============ SUPABASE CONFIG ============
const SUPABASE_URL = 'https://ynejdwoznotuxgfbrkaj.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InluZWpkd296bm90dXhnZmJya2FqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNjQzMzUsImV4cCI6MjA4NTY0MDMzNX0.dDohcO72OY6AVH_F_SvcCSCLlehG-uv7pVHkylqJC1w';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let familyCode = localStorage.getItem('familyCode') || null;

function generateFamilyCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 6; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
  return code;
}

// ============ CONNECTION STATE ============
let supabaseOnline = false;

function updateConnectionBanner(online) {
  supabaseOnline = online;
  const banner = document.getElementById('conn-banner');
  if (online) {
    banner.textContent = 'Connected to Mission HQ';
    banner.className = 'conn-banner online';
    setTimeout(() => banner.classList.add('hidden'), 2000);
  } else {
    banner.textContent = 'Reconnecting...';
    banner.className = 'conn-banner offline';
  }
}

// In-memory cache so getData() stays synchronous
let appDataCache = null;

function getData() {
  return appDataCache;
}

let lastSaveId = null; // guard against realtime overwriting local saves

function saveData(data) {
  // Generate unique save ID to detect our own echoes
  lastSaveId = genId();
  data._saveId = lastSaveId;

  appDataCache = JSON.parse(JSON.stringify(data)); // deep clone to cache
  // Always keep a localStorage backup
  try { localStorage.setItem('kidsTaskRewards_backup', JSON.stringify(data)); } catch (e) {}
  // Write to Supabase
  if (familyCode) {
    sb.from('families')
      .update({ data: data, family_name: data.householdName || '', base_name: 'Basecamp', parent_pin: data.parentPin || '' })
      .eq('id', familyCode)
      .then(({ error, count }) => {
        if (error) {
          console.error('Supabase write error:', error);
          updateConnectionBanner(false);
        } else {
          console.log('Saved to Supabase OK');
        }
      });
  }
}

// Re-render whichever screen is currently active
function rerenderCurrentScreen() {
  const active = document.querySelector('.screen.active');
  if (!active) return;
  const id = active.id;
  if (id === 'login-screen') renderLogin();
  else if (id === 'kid-home') renderKidHome();
  else if (id === 'kid-weekly') renderKidWeekly();
  else if (id === 'kid-extra') renderKidExtra();
  else if (id === 'kid-rewards') renderKidRewards();
  else if (id === 'parent-dashboard') renderParentDashboard();
}

// Real-time listener ‚Äî updates cache, re-renders on external changes, and monitors connection
let realtimeChannel = null;
function startRealtimeSync() {
  if (realtimeChannel) sb.removeChannel(realtimeChannel);
  if (!familyCode) return;

  realtimeChannel = sb
    .channel('family-' + familyCode)
    .on('postgres_changes',
      { event: 'UPDATE', schema: 'public', table: 'families', filter: 'id=eq.' + familyCode },
      (payload) => {
        const remoteData = payload.new.data;
        // Ignore realtime echoes of our own save by comparing save IDs
        if (remoteData._saveId && remoteData._saveId === lastSaveId) {
          updateConnectionBanner(true);
          return;
        }
        const remoteJSON = JSON.stringify(remoteData);
        const cacheJSON = JSON.stringify(appDataCache);
        if (remoteJSON !== cacheJSON) {
          appDataCache = JSON.parse(remoteJSON);
          try { localStorage.setItem('kidsTaskRewards_backup', remoteJSON); } catch (e) {}
          rerenderCurrentScreen();
        }
        updateConnectionBanner(true);
      }
    )
    .subscribe((status) => {
      if (status === 'SUBSCRIBED') updateConnectionBanner(true);
      else if (status === 'CLOSED' || status === 'CHANNEL_ERROR') updateConnectionBanner(false);
    });
}

// Async app initialization
async function initApp() {
  const statusEl = document.getElementById('loading-status');

  try {
    statusEl.textContent = 'Checking for mission credentials...';
    familyCode = localStorage.getItem('familyCode');

    if (familyCode) {
      statusEl.textContent = 'Loading mission data...';
      const { data: row, error } = await sb
        .from('families').select('data').eq('id', familyCode).single();

      if (error || !row) {
        console.warn('Family not found:', error);
        localStorage.removeItem('familyCode');
        familyCode = null;
        // Try localStorage backup
        const backup = localStorage.getItem('kidsTaskRewards_backup');
        if (backup) {
          appDataCache = JSON.parse(backup);
          if (appDataCache && appDataCache.setupComplete) {
            showScreen('error-screen');
            document.getElementById('error-backup-msg').style.display = 'block';
            return;
          }
        }
        showScreen('welcome-screen');
        return;
      }

      appDataCache = row.data;
      try { localStorage.setItem('kidsTaskRewards_backup', JSON.stringify(appDataCache)); } catch (e) {}
      startRealtimeSync();

      if (appDataCache && appDataCache.setupComplete) {
        renderLogin();
      } else {
        showScreen('welcome-screen');
      }
    } else {
      showScreen('welcome-screen');
    }
  } catch (err) {
    console.error('Init error:', err);
    const backup = localStorage.getItem('kidsTaskRewards_backup');
    if (backup) {
      appDataCache = JSON.parse(backup);
      if (appDataCache && appDataCache.setupComplete) { renderLogin(); return; }
    }
    showScreen('error-screen');
    if (backup) document.getElementById('error-backup-msg').style.display = 'block';
  }
}

function initData() {
  return {
    kids: [],
    tasks: [],
    rewards: [
      { id: genId(), title: 'Extra Screen Time', cost: 30, emoji: 'üì∫' },
      { id: genId(), title: 'Ice Cream', cost: 20, emoji: 'üç¶' },
      { id: genId(), title: 'Choose Dinner', cost: 25, emoji: 'üçï' },
      { id: genId(), title: 'Stay Up Late', cost: 40, emoji: 'üåô' },
    ],
    redemptions: [],
    bonusGrants: [],
    parentPin: '1234',
    householdName: '',
    setupComplete: false
  };
}

function genId() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 7); }

function getToday() { const d = new Date(); return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0'); }

function getWeekStart(dateObj) {
  // Handle string dates by appending T12:00:00 to force local time interpretation
  // (prevents UTC midnight parsing which can shift dates by a day)
  let d;
  if (!dateObj) {
    d = new Date();
  } else if (typeof dateObj === 'string') {
    d = new Date(dateObj + 'T12:00:00');
  } else {
    d = new Date(dateObj);
  }
  d.setDate(d.getDate() - d.getDay());
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

// Get array of 7 date strings (Sun-Sat) for the week containing the given date
function getWeekDates(weekStartStr) {
  const dates = [];
  const start = new Date(weekStartStr + 'T12:00:00'); // noon to avoid DST issues
  for (let i = 0; i < 7; i++) {
    const d = new Date(start);
    d.setDate(start.getDate() + i);
    dates.push(d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0'));
  }
  return dates;
}

function formatDateShort(dateStr) {
  const d = new Date(dateStr + 'T12:00:00');
  return `${d.getMonth()+1}/${d.getDate()}`;
}

// Backward-compatible helper: derive extra task mode from existing fields
function getExtraMode(task) {
  if (task.type !== 'extra') return null;
  if (task.extraMode) return task.extraMode;
  // Backward compat: existing tasks without extraMode
  if (task.assignedTo === 'shared') return 'rotating';
  return 'individual';
}

// Check if a task uses team completion (extra-team or shared type)
function isTeamTask(task) {
  return task.type === 'shared' || (task.type === 'extra' && getExtraMode(task) === 'team');
}

// ============ STATE ============
let currentKidId = null;
let pinCallback = null;
let parentWeekOffset = 0; // 0 = current week, -1 = last week, etc.

// ============ SCREENS ============

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function logout() {
  currentKidId = null;
  parentWeekOffset = 0;
  renderLogin();
  showScreen('login-screen');
}

// ============ SETUP ============

let setupKidCount = 1;

function renderSetup() {
  setupKidCount = 1;
  uploadedPhotos = {};
  setupKidNames = {};
  showScreen('setup-screen');
  renderSetupKids();
}

let setupKidNames = {};

function renderSetupKids() {
  // Save current names before re-rendering
  for (let i = 1; i <= setupKidCount + 1; i++) {
    const el = document.getElementById('setup-name-' + i);
    if (el) setupKidNames[i] = el.value;
  }
  const container = document.getElementById('setup-kids-container');
  let html = '';
  for (let i = 1; i <= setupKidCount; i++) {
    html += `<div class="setup-section">
      <h2>Agent ${i}${setupKidCount > 1 ? ` <button onclick="removeSetupKid(${i})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:0.8rem;vertical-align:middle">remove</button>` : ''}</h2>
      <input type="text" id="setup-name-${i}" placeholder="Agent name" value="${setupKidNames[i] || ''}">
      <div class="avatar-upload-wrap">
        <button class="avatar-upload-btn" onclick="document.getElementById('setup-photo-${i}').click()">Upload Photo</button>
        <img class="avatar-upload-preview" id="setup-preview-${i}" ${uploadedPhotos[i] ? 'src="' + uploadedPhotos[i] + '" class="avatar-upload-preview show"' : ''}>
        <input type="file" id="setup-photo-${i}" accept="image/*" style="display:none" onchange="handlePhotoUpload(${i}, this)">
      </div>
      <div class="avatar-or">‚Äî or pick an emoji ‚Äî</div>
      <div class="avatar-grid" id="setup-avatars-${i}"></div>
    </div>`;
  }
  container.innerHTML = html;
  // Populate emoji grids
  for (let i = 1; i <= setupKidCount; i++) {
    const c = document.getElementById('setup-avatars-' + i);
    c.innerHTML = AVATARS.map(a =>
      `<div class="avatar-option" data-kid="${i - 1}" data-avatar="${a}" onclick="selectSetupAvatar(this)">${a}</div>`
    ).join('');
  }
}

function addSetupKid() {
  setupKidCount++;
  renderSetupKids();
}

function removeSetupKid(n) {
  if (setupKidCount <= 1) return;
  // Save current names before removal
  for (let i = 1; i <= setupKidCount; i++) {
    const el = document.getElementById('setup-name-' + i);
    if (el) setupKidNames[i] = el.value;
  }
  // Shift photos and names down
  const newPhotos = {};
  const newNames = {};
  let j = 1;
  for (let i = 1; i <= setupKidCount; i++) {
    if (i === n) continue;
    newPhotos[j] = uploadedPhotos[i] || null;
    newNames[j] = setupKidNames[i] || '';
    j++;
  }
  uploadedPhotos = newPhotos;
  setupKidNames = newNames;
  setupKidCount--;
  renderSetupKids();
}

function showFamilyCodeEntry() {
  document.getElementById('family-code-entry').style.display = 'block';
  document.getElementById('family-code-input').value = '';
  document.getElementById('family-code-error').style.display = 'none';
  document.getElementById('family-code-input').focus();
}

function hideFamilyCodeEntry() {
  document.getElementById('family-code-entry').style.display = 'none';
}

async function joinFamily() {
  const input = document.getElementById('family-code-input');
  const errorEl = document.getElementById('family-code-error');
  const code = input.value.trim().toUpperCase();
  if (code.length !== 6) {
    errorEl.textContent = 'Code must be 6 characters.';
    errorEl.style.display = 'block';
    return;
  }
  errorEl.style.display = 'none';

  const { data: row, error } = await sb
    .from('families').select('data').eq('id', code).single();

  if (error || !row) {
    errorEl.textContent = 'Family not found. Check your code and try again.';
    errorEl.style.display = 'block';
    return;
  }

  familyCode = code;
  localStorage.setItem('familyCode', code);
  appDataCache = row.data;
  try { localStorage.setItem('kidsTaskRewards_backup', JSON.stringify(appDataCache)); } catch (e) {}
  startRealtimeSync();

  if (appDataCache && appDataCache.setupComplete) renderLogin();
  else showScreen('welcome-screen');
}

function loadFromBackup() {
  const backup = localStorage.getItem('kidsTaskRewards_backup');
  if (backup) {
    appDataCache = JSON.parse(backup);
    renderLogin();
  }
}

function selectSetupAvatar(el) {
  const kidNum = parseInt(el.dataset.kid) + 1;
  document.querySelectorAll(`#setup-avatars-${kidNum} .avatar-option`).forEach(a => a.classList.remove('selected'));
  el.classList.add('selected');
  uploadedPhotos[kidNum] = null;
  const preview = document.getElementById('setup-preview-' + kidNum);
  if (preview) preview.classList.remove('show');
}

async function completeSetup() {
  const householdName = document.getElementById('setup-household').value.trim();
  const pin = document.getElementById('setup-pin').value.trim();

  if (!householdName) return alert('Please enter your family name.');
  if (pin.length !== 4 || !/^\d+$/.test(pin)) return alert('Access code must be 4 digits.');

  // Collect kids dynamically
  const kids = [];
  for (let i = 1; i <= setupKidCount; i++) {
    const name = document.getElementById('setup-name-' + i).value.trim();
    const av = document.querySelector('#setup-avatars-' + i + ' .selected');
    const photo = uploadedPhotos[i];
    if (!name) return alert(`Please enter a name for Agent ${i}.`);
    if (!photo && !av) return alert(`Please pick an avatar or upload a photo for Agent ${i}.`);
    kids.push({ id: genId(), name: name, avatar: photo || av.dataset.avatar, points: 0, completedTasks: [] });
  }

  const data = initData();
  data.kids = kids;
  data.parentPin = pin;
  data.householdName = householdName;
  data.setupComplete = true;

  // Default tasks
  const defaultTasks = [
    { title: 'Brush teeth', type: 'daily', points: 5, assignedTo: 'both', requiresApproval: false, timeOfDay: 'morning', daysActive: 'everyday' },
    { title: 'Make bed', type: 'daily', points: 5, assignedTo: 'both', requiresApproval: false, timeOfDay: 'morning', daysActive: 'everyday' },
    { title: 'Get dressed', type: 'daily', points: 5, assignedTo: 'both', requiresApproval: false, timeOfDay: 'morning', daysActive: 'weekdays' },
    { title: 'Brush teeth', type: 'daily', points: 5, assignedTo: 'both', requiresApproval: false, timeOfDay: 'evening', daysActive: 'everyday' },
    { title: 'Pick up toys', type: 'daily', points: 5, assignedTo: 'both', requiresApproval: false, timeOfDay: 'evening', daysActive: 'everyday' },
    { title: 'Put on pajamas', type: 'daily', points: 5, assignedTo: 'both', requiresApproval: false, timeOfDay: 'evening', daysActive: 'everyday' },
    { title: 'Read for 20 minutes', type: 'daily', points: 10, assignedTo: 'both', requiresApproval: false, timeOfDay: 'anytime', daysActive: 'everyday' },
    { title: 'Clean room', type: 'weekly', points: 15, assignedTo: 'both', requiresApproval: true },
    { title: 'Help with laundry', type: 'weekly', points: 10, assignedTo: 'both', requiresApproval: true },
    { title: 'Water plants', type: 'extra', points: 10, assignedTo: 'shared', requiresApproval: false, claimedBy: null, repeatable: 'weekly', extraMode: 'rotating' },
    { title: 'Help cook dinner', type: 'extra', points: 15, assignedTo: 'both', requiresApproval: true, claimedBy: null, repeatable: 'daily', extraMode: 'team' },
  ];
  // For single-kid families, convert team/rotating tasks to individual
  if (data.kids.length === 1) {
    const kidId = data.kids[0].id;
    defaultTasks.forEach(t => {
      if (t.assignedTo === 'both' || t.assignedTo === 'shared') t.assignedTo = kidId;
      if (t.extraMode === 'team' || t.extraMode === 'rotating') t.extraMode = 'individual';
    });
  }
  data.tasks = defaultTasks.map(t => ({
    id: genId(), ...t,
    claimedBy: t.claimedBy || null,
    completions: []
  }));

  // Generate unique family code and insert into Supabase
  let code, inserted = false;
  for (let attempt = 0; attempt < 5; attempt++) {
    code = generateFamilyCode();
    const { error } = await sb.from('families').insert({
      id: code, family_name: householdName, base_name: 'Basecamp', parent_pin: pin, data: data
    });
    if (!error) { inserted = true; break; }
    if (error.code === '23505') continue; // duplicate key, retry
    console.error('Supabase insert error:', error);
    alert('Could not connect to Mission HQ. Check your connection and try again.');
    return;
  }
  if (!inserted) { alert('Could not generate a unique family code. Please try again.'); return; }

  familyCode = code;
  localStorage.setItem('familyCode', code);
  appDataCache = JSON.parse(JSON.stringify(data));
  try { localStorage.setItem('kidsTaskRewards_backup', JSON.stringify(data)); } catch (e) {}
  startRealtimeSync();

  alert('Your Family Code is: ' + code + '\n\nSave this code! You can use it on other devices to sync your family data.');
  renderLogin();
  showScreen('login-screen');
}

// ============ LOGIN ============

function renderLogin() {
  const data = getData();
  if (!data || !data.setupComplete) {
    showScreen('welcome-screen');
    return;
  }

  // Set household name in title
  const titleEl = document.getElementById('login-title');
  if (data.householdName) {
    titleEl.textContent = `The ${data.householdName} Basecamp`;
  } else {
    titleEl.textContent = 'Mission HQ';
  }

  const c = document.getElementById('login-kid-cards');
  c.innerHTML = data.kids.map(k => `
    <div class="kid-card" onclick="loginAsKid('${k.id}')">
      ${k.avatar.startsWith('data:')
        ? `<img class="avatar-img large" src="${k.avatar}" alt="${k.name}">`
        : `<span class="avatar">${k.avatar}</span>`}
      <span class="name">${k.name}</span>
    </div>
  `).join('');
  showScreen('login-screen');
}

function loginAsKid(kidId) {
  currentKidId = kidId;
  showKidTab('daily');
}

// ============ KID TABS ============

function showKidTab(tab) {
  if (tab === 'daily') {
    renderKidHome();
    showScreen('kid-home');
  } else if (tab === 'weekly') {
    renderKidWeekly();
    showScreen('kid-weekly');
  } else if (tab === 'extra') {
    renderKidExtra();
    showScreen('kid-extra');
  } else if (tab === 'rewards') {
    renderKidRewards();
    showScreen('kid-rewards');
  }
}

// ============ KID HOME (DAILY) ============

function renderKidHome() {
  const data = getData();
  const kid = data.kids.find(k => k.id === currentKidId);
  if (!kid) return;

  document.getElementById('kid-greeting').innerHTML = `${renderAvatar(kid.avatar, 'small')} Agent ${kid.name}`;
  document.getElementById('kid-points').innerHTML = `‚≠ê ${kid.points} pts`;

  const today = getToday();
  const now = new Date();
  const dayOfWeek = now.getDay(); // 0=Sun, 6=Sat
  const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
  const fullDayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];

  // Day header
  document.getElementById('kid-day-header').innerHTML =
    `<div class="day-header"><span class="day-name">${fullDayNames[dayOfWeek]}</span>, ${monthNames[now.getMonth()]} ${now.getDate()}</div>`;

  const dailyTasks = data.tasks.filter(t => {
    if (t.type !== 'daily') return false;
    if (t.assignedTo !== 'both' && t.assignedTo !== kid.id) return false;
    const days = t.daysActive || 'everyday';
    if (days === 'weekdays' && isWeekend) return false;
    if (days === 'weekends' && !isWeekend) return false;
    return true;
  });

  // Points summary
  const totalPossible = dailyTasks.reduce((sum, t) => sum + t.points, 0);
  const earnedToday = dailyTasks.reduce((sum, t) => {
    const ct = kid.completedTasks.find(c => c.taskId === t.id && c.date === today && c.approved);
    return ct ? sum + t.points : sum;
  }, 0);
  const doneCount = dailyTasks.filter(t => t.completions.find(c => c.kidId === kid.id && c.date === today)).length;

  document.getElementById('kid-daily-summary').innerHTML =
    `<div class="daily-summary">
      <span>${doneCount}/${dailyTasks.length} missions complete</span>
      <span><span class="earned">${earnedToday}</span> / <span class="possible">${totalPossible} pts</span> today</span>
    </div>`;

  const list = document.getElementById('daily-tasks');
  if (dailyTasks.length === 0) {
    list.innerHTML = '<div class="empty-state"><span class="emoji">üìã</span>No missions assigned yet!</div>';
    return;
  }

  const groups = [
    { key: 'morning', label: 'üåÖ Morning', icon: '' },
    { key: 'evening', label: 'üåô Evening', icon: '' },
    { key: 'anytime', label: '‚≠ê Anytime', icon: '' }
  ];

  let html = '';
  groups.forEach(group => {
    const tasks = dailyTasks.filter(t => (t.timeOfDay || 'anytime') === group.key);
    if (tasks.length === 0) return;

    html += `<div class="section-label">${group.label}</div>`;
    html += tasks.map(t => {
      const completion = t.completions.find(c => c.kidId === kid.id && c.date === today);
      const kidCompleted = kid.completedTasks.find(c => c.taskId === t.id && c.date === today);
      const done = !!completion;
      const pendingApproval = done && t.requiresApproval && kidCompleted && !kidCompleted.approved;
      const cls = done ? (pendingApproval ? 'task-item pending-approval' : 'task-item completed') : 'task-item';
      const check = done ? (pendingApproval ? '‚è≥' : '‚úì') : '';
      const meta = pendingApproval ? 'Awaiting HQ confirmation' : (done ? 'Mission accomplished!' : '');

      const action = done ? (pendingApproval ? '' : `showUncheckModal('${t.id}')`) : `completeTask('${t.id}')`;
      return `<div class="${cls}" onclick="${action}">
        <div class="task-check">${check}</div>
        <div class="task-info">
          <div class="task-title">${t.title}</div>
          <div class="task-meta">${meta}</div>
        </div>
        <div class="task-points">+${t.points}‚≠ê</div>
      </div>`;
    }).join('');
  });

  list.innerHTML = html;
}

// ============ KID WEEKLY ============

function renderKidWeekly() {
  const data = getData();
  const kid = data.kids.find(k => k.id === currentKidId);
  if (!kid) return;

  document.getElementById('kid-greeting-w').innerHTML = `${renderAvatar(kid.avatar, 'small')} Agent ${kid.name}`;
  document.getElementById('kid-points-w').innerHTML = `‚≠ê ${kid.points} pts`;

  const weekStart = getWeekStart();

  const weeklyTasks = data.tasks.filter(t =>
    t.type === 'weekly' && (t.assignedTo === 'both' || t.assignedTo === kid.id)
  );

  const container = document.getElementById('weekly-task-sections');
  let html = '';

  html += '<div class="section-label">Weekly Tasks</div><div class="task-list">';
  if (weeklyTasks.length === 0) {
    html += '<div class="empty-state"><span class="emoji">üìã</span>No weekly tasks assigned</div>';
  } else {
    html += weeklyTasks.map(t => renderWeeklyTaskItem(t, kid, weekStart)).join('');
  }
  html += '</div>';

  container.innerHTML = html;
}

// ============ KID EXTRA MISSIONS ============

function renderKidExtra() {
  const data = getData();
  const kid = data.kids.find(k => k.id === currentKidId);
  if (!kid) return;

  document.getElementById('kid-greeting-e').innerHTML = `${renderAvatar(kid.avatar, 'small')} Agent ${kid.name}`;
  document.getElementById('kid-points-e').innerHTML = `‚≠ê ${kid.points} pts`;

  const weekStart = getWeekStart();

  const allExtraTasks = data.tasks.filter(t =>
    t.type === 'extra' && (t.assignedTo === 'both' || t.assignedTo === kid.id || t.assignedTo === 'shared')
  );
  // Split: bonus (individual + rotating) vs team
  const bonusTasks = allExtraTasks.filter(t => getExtraMode(t) !== 'team');
  const teamExtraTasks = allExtraTasks.filter(t => getExtraMode(t) === 'team');
  // Legacy shared-type tasks also go in team section
  const legacySharedTasks = data.tasks.filter(t => t.type === 'shared');

  const container = document.getElementById('extra-task-sections');
  let html = '';

  // Bonus missions (individual + rotating)
  html += '<div class="section-label">Bonus Missions</div><div class="task-list">';
  if (bonusTasks.length === 0) {
    html += '<div class="empty-state"><span class="emoji">üåü</span>No bonus missions available</div>';
  } else {
    html += bonusTasks.map(t => renderExtraTaskItem(t, kid, weekStart)).join('');
  }
  html += '</div>';

  // Team missions (extra-team + legacy shared) ‚Äî hide for single-kid families
  if (data.kids.length > 1) {
    const allTeamTasks = [...teamExtraTasks, ...legacySharedTasks];
    html += '<div class="section-label">Team Missions</div><div class="task-list">';
    if (allTeamTasks.length === 0) {
      html += '<div class="empty-state"><span class="emoji">ü§ù</span>No team missions available</div>';
    } else {
      html += allTeamTasks.map(t => {
        if (t.type === 'shared') return renderSharedTaskItem(t, kid);
        return renderExtraTaskItem(t, kid, weekStart);
      }).join('');
    }
    html += '</div>';
  }

  container.innerHTML = html;
}

function renderWeeklyTaskItem(t, kid, weekStart) {
  const completion = t.completions.find(c => c.kidId === kid.id && c.date >= weekStart);
  const kidCompleted = kid.completedTasks.find(c => c.taskId === t.id && c.date >= weekStart);
  const done = !!completion;
  const pendingApproval = done && t.requiresApproval && kidCompleted && !kidCompleted.approved;
  const cls = done ? (pendingApproval ? 'task-item pending-approval' : 'task-item completed') : 'task-item';
  const check = done ? (pendingApproval ? '‚è≥' : '‚úì') : '';
  const meta = pendingApproval ? 'Awaiting HQ confirmation' : (done ? 'Mission accomplished!' : 'This week');

  const action = done ? (pendingApproval ? '' : `showUncheckModal('${t.id}')`) : `completeTask('${t.id}')`;
  return `<div class="${cls}" onclick="${action}">
    <div class="task-check">${check}</div>
    <div class="task-info"><div class="task-title">${t.title}</div><div class="task-meta">${meta}</div></div>
    <div class="task-points">+${t.points}‚≠ê</div>
  </div>`;
}

function renderExtraTaskItem(t, kid, weekStart) {
  const mode = getExtraMode(t);
  const rep = t.repeatable || 'once';
  const periodStart = rep === 'daily' ? getToday() : rep === 'weekly' ? weekStart : '1970-01-01';
  const completion = t.completions.find(c => c.kidId === kid.id && c.date >= periodStart);
  const kidCompleted = kid.completedTasks.find(c => c.taskId === t.id && c.date >= periodStart);
  const done = !!completion;
  const pendingApproval = done && t.requiresApproval && kidCompleted && !kidCompleted.approved;

  // === TEAM MODE ===
  if (mode === 'team') {
    if (done) {
      const cls = pendingApproval ? 'task-item pending-approval' : 'task-item completed';
      const check = pendingApproval ? '‚è≥' : '‚úì';
      const meta = pendingApproval ? 'Team ‚Äî awaiting HQ confirmation' : 'Team mission accomplished!';
      const action = pendingApproval ? '' : `showUncheckModal('${t.id}')`;
      return `<div class="${cls}" onclick="${action}">
        <div class="task-check">${check}</div>
        <div class="task-info"><div class="task-title">ü§ù ${t.title}</div><div class="task-meta">${meta}</div></div>
        <div class="task-points">+${t.points}‚≠ê</div>
      </div>`;
    }
    return `<div class="task-item" onclick="completeTask('${t.id}')">
      <div class="task-check"></div>
      <div class="task-info"><div class="task-title">ü§ù ${t.title}</div><div class="task-meta">Team mission ‚Äî both agents get points!</div></div>
      <div class="task-points">+${t.points}‚≠ê</div>
    </div>`;
  }

  // === ROTATING MODE ===
  if (mode === 'rotating') {
    if (done) {
      const cls = pendingApproval ? 'task-item pending-approval' : 'task-item completed';
      const check = pendingApproval ? '‚è≥' : '‚úì';
      const meta = pendingApproval ? 'Awaiting HQ confirmation' : 'Mission accomplished!';
      const action = pendingApproval ? '' : `showUncheckModal('${t.id}')`;
      return `<div class="${cls}" onclick="${action}">
        <div class="task-check">${check}</div>
        <div class="task-info"><div class="task-title">${t.title}</div><div class="task-meta">${meta}</div></div>
        <div class="task-points">+${t.points}‚≠ê</div>
      </div>`;
    }

    const claimed = t.claimedBy;
    const claimedByMe = claimed === kid.id;
    const claimedByOther = claimed && claimed !== kid.id;

    if (claimedByOther) {
      const data = getData();
      const otherKid = data.kids.find(k => k.id === claimed);
      return `<div class="task-item" style="opacity:0.5">
        <div class="task-check"></div>
        <div class="task-info"><div class="task-title">${t.title}</div><div class="task-meta">Claimed by ${otherKid ? otherKid.name : 'other'}</div></div>
        <div class="task-points">+${t.points}‚≠ê</div>
      </div>`;
    }

    if (claimedByMe) {
      return `<div class="task-item" onclick="completeTask('${t.id}')">
        <div class="task-check"></div>
        <div class="task-info"><div class="task-title">${t.title}</div><div class="task-meta">Mission accepted ‚Äî tap to complete!</div></div>
        <div class="task-points">+${t.points}‚≠ê</div>
      </div>`;
    }

    return `<div class="task-item">
      <div class="task-check"></div>
      <div class="task-info"><div class="task-title">${t.title}</div><div class="task-meta">First agent to claim it!</div></div>
      <button class="claim-btn" onclick="event.stopPropagation();claimTask('${t.id}')">Accept</button>
      <div class="task-points">+${t.points}‚≠ê</div>
    </div>`;
  }

  // === INDIVIDUAL MODE ===
  if (done) {
    const cls = pendingApproval ? 'task-item pending-approval' : 'task-item completed';
    const check = pendingApproval ? '‚è≥' : '‚úì';
    const meta = pendingApproval ? 'Awaiting HQ confirmation' : 'Mission accomplished!';
    const action = pendingApproval ? '' : `showUncheckModal('${t.id}')`;
    return `<div class="${cls}" onclick="${action}">
      <div class="task-check">${check}</div>
      <div class="task-info"><div class="task-title">${t.title}</div><div class="task-meta">${meta}</div></div>
      <div class="task-points">+${t.points}‚≠ê</div>
    </div>`;
  }

  return `<div class="task-item" onclick="completeTask('${t.id}')">
    <div class="task-check"></div>
    <div class="task-info"><div class="task-title">${t.title}</div><div class="task-meta">Bonus mission</div></div>
    <div class="task-points">+${t.points}‚≠ê</div>
  </div>`;
}

function renderSharedTaskItem(t, kid) {
  const today = getToday();
  const myCompletion = kid.completedTasks.find(c => c.taskId === t.id && c.date === today);
  const doneToday = !!myCompletion;
  const pendingApproval = doneToday && t.requiresApproval && !myCompletion.approved;

  if (doneToday) {
    const cls = pendingApproval ? 'task-item pending-approval' : 'task-item completed';
    const check = pendingApproval ? '‚è≥' : '‚úì';
    const meta = pendingApproval ? 'Team ‚Äî awaiting HQ confirmation' : 'Team mission accomplished!';
    return `<div class="${cls}">
      <div class="task-check">${check}</div>
      <div class="task-info"><div class="task-title">ü§ù ${t.title}</div><div class="task-meta">${meta}</div></div>
      <div class="task-points">+${t.points}‚≠ê</div>
    </div>`;
  }

  return `<div class="task-item">
    <div class="task-check"></div>
    <div class="task-info"><div class="task-title">ü§ù ${t.title}</div><div class="task-meta">Team mission ‚Äî both agents get points!</div></div>
    <button class="didit-btn" onclick="event.stopPropagation();completeTask('${t.id}')">Done!</button>
    <div class="task-points">+${t.points}‚≠ê</div>
  </div>`;
}

// ============ TASK ACTIONS ============

let pendingUncheckTaskId = null;

function showUncheckModal(taskId) {
  const data = getData();
  const task = data.tasks.find(t => t.id === taskId);
  if (!task) return;
  pendingUncheckTaskId = taskId;
  document.getElementById('uncheck-task-name').textContent = task.title;
  document.getElementById('uncheck-modal').classList.add('show');
}

function confirmUncompleteTask() {
  if (pendingUncheckTaskId) {
    uncompleteTask(pendingUncheckTaskId);
    pendingUncheckTaskId = null;
  }
  closeModal('uncheck-modal');
}

function claimTask(taskId) {
  const data = getData();
  const task = data.tasks.find(t => t.id === taskId);
  if (!task || task.claimedBy) return;
  task.claimedBy = currentKidId;
  saveData(data);
  renderKidWeekly();
}

function completeTask(taskId) {
  const data = getData();
  const task = data.tasks.find(t => t.id === taskId);
  const kid = data.kids.find(k => k.id === currentKidId);
  if (!task || !kid) return;

  let dateKey;
  if (task.type === 'daily') {
    dateKey = getToday();
  } else if (task.type === 'shared') {
    dateKey = getToday();
  } else if (task.type === 'extra') {
    const rep = task.repeatable || 'once';
    dateKey = rep === 'daily' ? getToday() : rep === 'weekly' ? getWeekStart() : getToday();
  } else {
    dateKey = getWeekStart();
  }

  // === TEAM COMPLETION (shared type or extra-team) ===
  if (isTeamTask(task)) {
    // Check if this kid already completed it
    const already = task.completions.find(c => c.kidId === kid.id && c.date === dateKey);
    if (already) return;

    // Complete for ALL kids at once
    data.kids.forEach(k => {
      const alreadyK = task.completions.find(c => c.kidId === k.id && c.date === dateKey);
      if (alreadyK) return;
      task.completions.push({ kidId: k.id, date: dateKey });
      if (task.requiresApproval) {
        k.completedTasks.push({ taskId: task.id, date: dateKey, approved: false });
      } else {
        k.points += task.points;
        k.completedTasks.push({ taskId: task.id, date: dateKey, approved: true });
      }
    });

    // Handle extra one-time removal (no-approval path)
    if (!task.requiresApproval && task.type === 'extra') {
      const rep = task.repeatable || 'once';
      if (rep === 'once') {
        data.tasks = data.tasks.filter(t => t.id !== taskId);
      }
    }

    saveData(data);
    if (task.requiresApproval) {
      showCelebration('Sent to HQ for approval! ‚è≥');
    } else {
      showCelebration(`Team mission accomplished! +${task.points} üéâ`);
      triggerConfetti();
    }

    const activeScreen = document.querySelector('.screen.active');
    if (activeScreen.id === 'kid-home') renderKidHome();
    else if (activeScreen.id === 'kid-weekly') renderKidWeekly();
    else if (activeScreen.id === 'kid-extra') renderKidExtra();
    return;
  }

  // === STANDARD COMPLETION (individual, rotating, daily, weekly) ===
  const already = task.completions.find(c => c.kidId === kid.id && c.date === dateKey);
  if (already) return;

  task.completions.push({ kidId: kid.id, date: dateKey });

  if (task.requiresApproval) {
    kid.completedTasks.push({ taskId: task.id, date: dateKey, approved: false });
    saveData(data);
    showCelebration('Sent to HQ for approval! ‚è≥');
  } else {
    kid.points += task.points;
    kid.completedTasks.push({ taskId: task.id, date: dateKey, approved: true });

    // Handle extra task repeatable behavior (no-approval path)
    if (task.type === 'extra') {
      const rep = task.repeatable || 'once';
      if (rep === 'once') {
        data.tasks = data.tasks.filter(t => t.id !== taskId);
      } else {
        task.claimedBy = null;
      }
      // Track last completed by for rotating tasks
      if (getExtraMode(task) === 'rotating') {
        task.lastCompletedBy = kid.id;
      }
    }

    saveData(data);
    showCelebration(`Mission accomplished! +${task.points} üéâ`);
    triggerConfetti();
  }

  const activeScreen = document.querySelector('.screen.active');
  if (activeScreen.id === 'kid-home') renderKidHome();
  else if (activeScreen.id === 'kid-weekly') renderKidWeekly();
  else if (activeScreen.id === 'kid-extra') renderKidExtra();
}

function uncompleteTask(taskId) {
  const data = getData();
  const task = data.tasks.find(t => t.id === taskId);
  const kid = data.kids.find(k => k.id === currentKidId);
  if (!task || !kid) return;

  let dateKey;
  if (task.type === 'daily') {
    dateKey = getToday();
  } else if (task.type === 'extra') {
    const rep = task.repeatable || 'once';
    dateKey = rep === 'daily' ? getToday() : rep === 'weekly' ? getWeekStart() : getToday();
  } else {
    dateKey = getWeekStart();
  }

  // Remove from task.completions
  const compIdx = task.completions.findIndex(c => c.kidId === kid.id && c.date === dateKey);
  if (compIdx === -1) return;
  task.completions.splice(compIdx, 1);

  // Remove from kid.completedTasks and deduct points if it was approved
  const ctIdx = kid.completedTasks.findIndex(c => c.taskId === task.id && c.date === dateKey);
  if (ctIdx !== -1) {
    const ct = kid.completedTasks[ctIdx];
    if (ct.approved) {
      kid.points = Math.max(0, kid.points - task.points);
    }
    kid.completedTasks.splice(ctIdx, 1);
  }

  saveData(data);

  const activeScreen = document.querySelector('.screen.active');
  if (activeScreen.id === 'kid-home') renderKidHome();
  else if (activeScreen.id === 'kid-weekly') renderKidWeekly();
  else if (activeScreen.id === 'kid-extra') renderKidExtra();
}

// ============ KID REWARDS ============

function renderKidRewards() {
  const data = getData();
  const kid = data.kids.find(k => k.id === currentKidId);
  if (!kid) return;

  document.getElementById('kid-greeting-r').innerHTML = `${renderAvatar(kid.avatar, 'small')} Agent ${kid.name}`;
  document.getElementById('kid-points-r').innerHTML = `‚≠ê ${kid.points} pts`;

  const grid = document.getElementById('rewards-grid');
  if (data.rewards.length === 0) {
    grid.innerHTML = '<div class="empty-state"><span class="emoji">üéÅ</span>No rewards in the vault yet!</div>';
    return;
  }

  grid.innerHTML = data.rewards.map(r => {
    const canAfford = kid.points >= r.cost;
    return `<div class="reward-card">
      <span class="emoji">${r.emoji}</span>
      <div class="title">${r.title}</div>
      <div class="cost">${r.cost} ‚≠ê</div>
      <button class="btn btn-green" ${canAfford ? '' : 'disabled'} onclick="redeemReward('${r.id}')">
        ${canAfford ? 'Redeem!' : 'Need more ‚≠ê'}
      </button>
    </div>`;
  }).join('');
}

function redeemReward(rewardId) {
  const data = getData();
  const kid = data.kids.find(k => k.id === currentKidId);
  const reward = data.rewards.find(r => r.id === rewardId);
  if (!kid || !reward || kid.points < reward.cost) return;

  if (!confirm(`Redeem "${reward.title}" for ${reward.cost} points?`)) return;

  kid.points -= reward.cost;
  data.redemptions.push({ id: genId(), kidId: kid.id, rewardId: reward.id, date: getToday() });
  saveData(data);
  showCelebration(`${reward.emoji} Redeemed!`);
  triggerConfetti();
  renderKidRewards();
}

// ============ PIN MODAL ============

function showPinModal(action) {
  pinCallback = action;
  document.getElementById('pin-modal').classList.add('show');
  document.getElementById('pin-error').textContent = '';
  const inputs = document.querySelectorAll('.pin-input input');
  inputs.forEach(i => i.value = '');
  inputs[0].focus();
}

function closePinModal() {
  document.getElementById('pin-modal').classList.remove('show');
  pinCallback = null;
}

// PIN input auto-advance
document.querySelectorAll('.pin-input input').forEach((inp, idx, all) => {
  inp.addEventListener('input', () => {
    if (inp.value.length === 1 && idx < 3) all[idx + 1].focus();
    if (idx === 3 && inp.value.length === 1) checkPin();
  });
  inp.addEventListener('keydown', (e) => {
    if (e.key === 'Backspace' && inp.value === '' && idx > 0) all[idx - 1].focus();
  });
});

function checkPin() {
  const data = getData();
  const pin = Array.from(document.querySelectorAll('.pin-input input')).map(i => i.value).join('');
  if (pin === data.parentPin) {
    const action = pinCallback;
    closePinModal();
    if (action === 'login') {
      currentKidId = null;
      parentWeekOffset = 0;
      renderParentDashboard();
      showScreen('parent-dashboard');
    }
  } else {
    document.getElementById('pin-error').textContent = 'Access denied. Try again.';
    const inputs = document.querySelectorAll('.pin-input input');
    inputs.forEach(i => i.value = '');
    inputs[0].focus();
  }
}

// ============ PARENT DASHBOARD ============

function showParentTab(tab, btnEl) {
  document.querySelectorAll('.parent-tab').forEach(t => t.classList.remove('active'));
  if (btnEl) btnEl.classList.add('active');
  else document.querySelector(`.parent-tab[data-tab="${tab}"]`).classList.add('active');

  document.querySelectorAll('.parent-section').forEach(s => s.classList.remove('active'));
  document.getElementById('parent-' + tab).classList.add('active');

  if (tab === 'overview') renderParentOverview();
  else if (tab === 'tasks') renderParentTasks();
  else if (tab === 'rewards') renderParentRewards();
  else if (tab === 'approvals') renderParentApprovals();
  else if (tab === 'history') renderParentHistory();
}

function renderParentDashboard() {
  const data = getData();
  const headerTitle = document.getElementById('parent-header-title');
  if (data && data.householdName) {
    headerTitle.textContent = `The ${data.householdName} Basecamp`;
  }
  const codeEl = document.getElementById('family-code-value');
  if (codeEl && familyCode) codeEl.textContent = familyCode;
  renderParentOverview();
  document.querySelectorAll('.parent-tab').forEach(t => t.classList.remove('active'));
  document.querySelector('.parent-tab[data-tab="overview"]').classList.add('active');
  document.querySelectorAll('.parent-section').forEach(s => s.classList.remove('active'));
  document.getElementById('parent-overview').classList.add('active');
}

function getViewWeekStart() {
  const d = new Date();
  d.setDate(d.getDate() - d.getDay() + (parentWeekOffset * 7));
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

function renderParentOverview() {
  const data = getData();
  const today = getToday();
  const weekStartStr = getViewWeekStart();
  const weekDates = getWeekDates(weekStartStr);
  const container = document.getElementById('parent-overview');

  // Week navigation
  const weekEnd = weekDates[6];
  let html = `<div class="week-nav">
    <button onclick="parentWeekOffset--;renderParentOverview()">‚óÄ</button>
    <span class="week-label">${formatDateShort(weekStartStr)} ‚Äî ${formatDateShort(weekEnd)}</span>
    <button onclick="parentWeekOffset++;renderParentOverview()" ${parentWeekOffset >= 0 ? 'disabled' : ''}>‚ñ∂</button>
    ${parentWeekOffset !== 0 ? `<button onclick="parentWeekOffset=0;renderParentOverview()" style="font-size:0.8rem">Today</button>` : ''}
  </div>`;

  // Build a grid card for each kid
  data.kids.forEach(kid => {
    // Daily tasks for this kid
    const dailyTasks = data.tasks.filter(t =>
      t.type === 'daily' && (t.assignedTo === 'both' || t.assignedTo === kid.id)
    );
    // Weekly tasks for this kid
    const weeklyTasks = data.tasks.filter(t =>
      t.type === 'weekly' && (t.assignedTo === 'both' || t.assignedTo === kid.id)
    );

    // Progress summary
    const todayDailyDone = dailyTasks.filter(t =>
      t.completions.find(c => c.kidId === kid.id && c.date === today)
    ).length;
    const weekWeeklyDone = weeklyTasks.filter(t =>
      t.completions.find(c => c.kidId === kid.id && c.date >= weekStartStr)
    ).length;
    const dailyPct = dailyTasks.length ? Math.round(todayDailyDone / dailyTasks.length * 100) : 0;

    html += `<div class="weekly-grid-card">
      <h3>${renderAvatar(kid.avatar, 'small')} ${kid.name} <span style="font-size:0.85rem;font-weight:400;color:#888">‚Äî ‚≠ê ${kid.points} pts</span></h3>
      <div class="stat-row" style="margin-bottom:8px">
        <span>Today: ${todayDailyDone}/${dailyTasks.length} daily</span>
        <span>Weekly: ${weekWeeklyDone}/${weeklyTasks.length}</span>
      </div>
      <div class="progress-bar-wrap"><div class="progress-bar-fill" style="width:${dailyPct}%"></div></div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn btn-orange" style="padding:8px 16px;font-size:0.7rem;min-width:0" onclick="openBonusModal('${kid.id}')">‚≠ê Grant Bonus</button>
        <button class="btn btn-pink" style="padding:8px 16px;font-size:0.7rem;min-width:0" onclick="openDeductModal('${kid.id}')">Remove Stars</button>
      </div>`;

    // Daily tasks grid (Sun-Sat) ‚Äî one table, grouped by time of day
    if (dailyTasks.length > 0) {
      html += `<div style="margin-top:14px;font-weight:700;font-size:0.85rem;color:var(--text-muted)">Daily Missions</div>`;
      html += '<table class="weekly-grid"><thead><tr><th>Task</th>';
      weekDates.forEach((d, i) => {
        const isToday = d === today;
        html += `<th class="${isToday ? 'today' : ''}">${DAY_NAMES[i]}<br>${formatDateShort(d)}</th>`;
      });
      html += '</tr></thead><tbody>';

      const timeGroups = [
        { key: 'morning', label: 'üåÖ Morning' },
        { key: 'evening', label: 'üåô Evening' },
        { key: 'anytime', label: '‚≠ê Anytime' }
      ];

      timeGroups.forEach(group => {
        const groupTasks = dailyTasks.filter(t => (t.timeOfDay || 'anytime') === group.key);
        if (groupTasks.length === 0) return;

        html += `<tr><td colspan="${weekDates.length + 1}" style="font-weight:700;font-size:0.8rem;color:var(--text-muted);padding:8px 4px 2px;border:none;background:transparent">${group.label}</td></tr>`;

        groupTasks.forEach(t => {
          const days = t.daysActive || 'everyday';
          const daysLabel = days === 'weekdays' ? ' <span class="pts-label">Mon‚ÄìFri</span>' : days === 'weekends' ? ' <span class="pts-label">Sat‚ÄìSun</span>' : '';
          html += `<tr><td>${t.title} <span class="pts-label">${t.points}pts</span>${daysLabel}</td>`;
          weekDates.forEach((d, i) => {
            const isWkend = i === 0 || i === 6;
            const taskActive = days === 'everyday' || (days === 'weekdays' && !isWkend) || (days === 'weekends' && isWkend);

            if (!taskActive) {
              html += `<td><span class="check-miss" style="color:#eee">‚Äî</span></td>`;
            } else {
              const completion = t.completions.find(c => c.kidId === kid.id && c.date === d);
              const ct = kid.completedTasks.find(c => c.taskId === t.id && c.date === d);
              if (completion) {
                if (t.requiresApproval && ct && !ct.approved) {
                  html += `<td><span class="check-pending">‚è≥</span></td>`;
                } else {
                  html += `<td><span class="check-done">‚úì</span></td>`;
                }
              } else if (d < today) {
                html += `<td><span class="check-miss">‚úó</span></td>`;
              } else if (d === today) {
                html += `<td><span class="check-miss">‚óã</span></td>`;
              } else {
                html += `<td><span class="check-miss">¬∑</span></td>`;
              }
            }
          });
          html += '</tr>';
        });
      });
      html += '</tbody></table>';
    }

    // Extra tasks for this kid
    const extraTasks = data.tasks.filter(t =>
      (t.type === 'extra' || t.type === 'shared') && (t.assignedTo === 'both' || t.assignedTo === kid.id || t.assignedTo === 'shared')
    );
    if (extraTasks.length > 0) {
      html += `<div style="margin-top:14px;font-weight:700;font-size:0.85rem;color:var(--text-muted)">üéØ Extra Missions</div>`;
      html += '<table class="weekly-grid"><thead><tr><th>Task</th><th>Status</th></tr></thead><tbody>';
      extraTasks.forEach(t => {
        const completion = t.completions.find(c => c.kidId === kid.id && c.date === today);
        const ct = kid.completedTasks.find(c => c.taskId === t.id && c.date === today);
        let status;
        if (completion) {
          if (t.requiresApproval && ct && !ct.approved) {
            status = '<span class="check-pending">‚è≥ Pending</span>';
          } else {
            status = '<span class="check-done">‚úì Done</span>';
          }
        } else {
          status = '<span class="check-miss">‚óã Available</span>';
        }
        html += `<tr><td>${t.title} <span class="pts-label">${t.points}pts</span></td><td>${status}</td></tr>`;
      });
      html += '</tbody></table>';
    }

    // Weekly tasks section
    if (weeklyTasks.length > 0) {
      html += `<div style="margin-top:14px;font-weight:700;font-size:0.85rem;color:var(--text-muted)">Weekly Tasks</div>`;
      html += '<table class="weekly-grid"><thead><tr><th>Task</th><th>Status</th></tr></thead><tbody>';
      weeklyTasks.forEach(t => {
        const completion = t.completions.find(c => c.kidId === kid.id && c.date >= weekStartStr);
        const ct = kid.completedTasks.find(c => c.taskId === t.id && c.date >= weekStartStr);
        let status;
        if (completion) {
          if (t.requiresApproval && ct && !ct.approved) {
            status = '<span class="check-pending">‚è≥ Pending</span>';
          } else {
            status = '<span class="check-done">‚úì Done</span>';
          }
        } else {
          status = '<span class="check-miss">‚óã Not done</span>';
        }
        html += `<tr><td>${t.title} <span class="pts-label">${t.points}pts</span></td><td>${status}</td></tr>`;
      });
      html += '</tbody></table>';
    }

    // Bonus points today
    const bonusGrants = (data.bonusGrants || []).filter(b => b.kidId === kid.id && b.date === today);
    if (bonusGrants.length > 0) {
      html += `<div style="margin-top:14px;font-weight:700;font-size:0.85rem;color:var(--text-muted)">Bonus Points Today</div>`;
      html += '<div class="bonus-history">';
      bonusGrants.forEach(b => {
        html += `<div class="bonus-history-item"><span class="bonus-reason">‚≠ê ${b.reason}</span><span class="bonus-pts">+${b.points} pts</span></div>`;
      });
      html += '</div>';
    }

    html += '</div>';
  });

  // Manage agents section
  html += `<div style="margin-top:20px;text-align:center;display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
    <button class="btn btn-green" style="padding:10px 20px;font-size:0.8rem" onclick="openAddKidModal()">+ Add Agent</button>
    ${data.kids.length > 1 ? data.kids.map(k =>
      `<button class="btn btn-pink" style="padding:10px 16px;font-size:0.7rem" onclick="removeKid('${k.id}')">Remove ${k.name}</button>`
    ).join('') : ''}
  </div>`;

  container.innerHTML = html;
}

// ============ PARENT TASKS ============

function renderParentTasks() {
  const data = getData();
  const container = document.getElementById('parent-tasks');

  let html = `<button class="btn btn-blue" onclick="openTaskModal()" style="margin-bottom:16px">+ New Mission</button>`;

  // Helper to render a single task crud item
  function renderTaskCrudItem(t) {
    const assignLabel = t.assignedTo === 'both' ? 'Everyone' :
      t.assignedTo === 'shared' ? 'Rotating' :
      (data.kids.find(k => k.id === t.assignedTo)?.name || t.assignedTo);

    let metaParts = [];
    // Points
    metaParts.push(`<input type="number" class="inline-points" value="${t.points}" min="0" max="100" onchange="updateTaskPoints('${t.id}', this.value)"> pts`);

    if (t.type === 'extra') {
      const mode = getExtraMode(t);
      if (mode === 'individual') metaParts.push(assignLabel);
      if (mode === 'rotating' && t.lastCompletedBy) {
        const lastKid = data.kids.find(k => k.id === t.lastCompletedBy);
        if (lastKid) metaParts.push(`Last: ${lastKid.name}`);
      }
      metaParts.push({once:'One-time', daily:'Repeats daily', weekly:'Repeats weekly'}[t.repeatable || 'once']);
    } else {
      metaParts.push(assignLabel);
    }

    if (t.timeOfDay && t.type === 'daily') metaParts.push(t.timeOfDay);
    if (t.daysActive && t.daysActive !== 'everyday' && t.type === 'daily') {
      metaParts.push(t.daysActive === 'weekdays' ? 'Mon‚ÄìFri' : 'Sat‚ÄìSun');
    }
    if (t.requiresApproval) metaParts.push('Needs approval');

    const icon = (t.type === 'extra' && getExtraMode(t) === 'team') || t.type === 'shared' ? 'ü§ù ' : '';

    return `<div class="crud-item">
      <div class="info">
        <div class="label">${icon}${t.title}</div>
        <div class="meta">${metaParts.join(' ¬∑ ')}</div>
      </div>
      <div class="actions">
        <button class="icon-btn edit" onclick="openTaskModal('${t.id}')">‚úèÔ∏è</button>
        <button class="icon-btn delete" onclick="deleteTask('${t.id}')">üóëÔ∏è</button>
      </div>
    </div>`;
  }

  // --- Daily Missions ---
  const dailyTasks = data.tasks.filter(t => t.type === 'daily');
  if (dailyTasks.length > 0) {
    html += '<div class="section-label">Daily Missions</div><div class="crud-list">';
    html += dailyTasks.map(renderTaskCrudItem).join('');
    html += '</div>';
  }

  // --- Weekly Tasks ---
  const weeklyTasks = data.tasks.filter(t => t.type === 'weekly');
  if (weeklyTasks.length > 0) {
    html += '<div class="section-label">Weekly Tasks</div><div class="crud-list">';
    html += weeklyTasks.map(renderTaskCrudItem).join('');
    html += '</div>';
  }

  // --- Extra Missions (individual + rotating) ---
  const extraNonTeam = data.tasks.filter(t => t.type === 'extra' && getExtraMode(t) !== 'team');
  if (extraNonTeam.length > 0) {
    html += '<div class="section-label">Extra Missions</div><div class="crud-list">';
    html += extraNonTeam.map(renderTaskCrudItem).join('');
    html += '</div>';
  }

  // --- Team Missions (extra-team + legacy shared) ‚Äî hide for single-kid families ---
  if (data.kids.length > 1) {
    const teamTasks = data.tasks.filter(t =>
      (t.type === 'extra' && getExtraMode(t) === 'team') || t.type === 'shared'
    );
    if (teamTasks.length > 0) {
      html += '<div class="section-label">Team Missions</div><div class="crud-list">';
      html += teamTasks.map(renderTaskCrudItem).join('');
      html += '</div>';
    }
  }

  if (data.tasks.length === 0) {
    html += '<div class="empty-state"><span class="emoji">üìã</span>No missions assigned yet. Add one above!</div>';
  }

  container.innerHTML = html;
}

function updateTaskPoints(taskId, value) {
  const pts = parseInt(value);
  if (isNaN(pts) || pts < 0) return;
  const data = getData();
  const task = data.tasks.find(t => t.id === taskId);
  if (task) {
    task.points = pts;
    saveData(data);
  }
}

function openTaskModal(taskId) {
  const data = getData();
  document.getElementById('task-edit-id').value = taskId || '';
  document.getElementById('task-modal-title').textContent = taskId ? 'Edit Mission' : 'New Mission';

  const sel = document.getElementById('task-edit-assigned');
  const isSingleKid = data.kids.length === 1;
  sel.innerHTML = isSingleKid
    ? `${data.kids.map(k => `<option value="${k.id}">${k.name}</option>`).join('')}`
    : `<option value="both">Everyone</option>
    ${data.kids.map(k => `<option value="${k.id}">${k.name}</option>`).join('')}`;

  // Hide rotating/team extra mode options for single-kid families
  const extraModeSelect = document.getElementById('task-edit-extra-mode');
  extraModeSelect.querySelectorAll('option').forEach(opt => {
    if (opt.value === 'rotating' || opt.value === 'team') {
      opt.style.display = isSingleKid ? 'none' : '';
    }
  });
  // Hide assigned-to for single-kid families (always auto-assigned)
  if (isSingleKid) {
    document.getElementById('task-edit-assigned-wrap').style.display = 'none';
  }

  if (taskId) {
    const t = data.tasks.find(x => x.id === taskId);
    if (!t) return;
    document.getElementById('task-edit-title').value = t.title;
    document.getElementById('task-edit-type').value = t.type;
    document.getElementById('task-edit-points').value = t.points;
    document.getElementById('task-edit-assigned').value = t.assignedTo;
    document.getElementById('task-edit-approval').checked = t.requiresApproval;
    document.getElementById('task-edit-timeofday').value = t.timeOfDay || 'anytime';
    document.getElementById('task-edit-days').value = t.daysActive || 'everyday';
    document.getElementById('task-edit-repeatable').value = t.repeatable || 'once';
    document.getElementById('task-edit-extra-mode').value = getExtraMode(t) || 'individual';
  } else {
    document.getElementById('task-edit-title').value = '';
    document.getElementById('task-edit-type').value = 'daily';
    document.getElementById('task-edit-points').value = 5;
    document.getElementById('task-edit-assigned').value = 'both';
    document.getElementById('task-edit-approval').checked = false;
    document.getElementById('task-edit-timeofday').value = 'anytime';
    document.getElementById('task-edit-days').value = 'everyday';
    document.getElementById('task-edit-repeatable').value = 'once';
    document.getElementById('task-edit-extra-mode').value = 'individual';
  }

  toggleTimeOfDayField();
  document.getElementById('task-modal').classList.add('show');
}

function toggleTimeOfDayField() {
  const type = document.getElementById('task-edit-type').value;
  document.getElementById('task-edit-daily-options').style.display = type === 'daily' ? 'block' : 'none';
  document.getElementById('task-edit-extra-options').style.display = type === 'extra' ? 'block' : 'none';
  toggleExtraModeOptions();
}

function toggleExtraModeOptions() {
  const data = getData();
  const type = document.getElementById('task-edit-type').value;
  const extraMode = document.getElementById('task-edit-extra-mode').value;
  // Hide assigned-to for rotating/team extra tasks (auto-determined)
  // Also always hide for single-kid families (auto-assigned)
  const isSingleKid = data.kids.length === 1;
  const hideAssigned = isSingleKid || (type === 'extra' && (extraMode === 'rotating' || extraMode === 'team'));
  document.getElementById('task-edit-assigned-wrap').style.display = hideAssigned ? 'none' : 'block';
}

function saveTask() {
  const data = getData();
  const id = document.getElementById('task-edit-id').value;
  const title = document.getElementById('task-edit-title').value.trim();
  const type = document.getElementById('task-edit-type').value;
  const points = parseInt(document.getElementById('task-edit-points').value);
  const finalPoints = isNaN(points) ? 5 : Math.max(0, Math.min(100, points));
  const assignedTo = document.getElementById('task-edit-assigned').value;
  const requiresApproval = document.getElementById('task-edit-approval').checked;
  const timeOfDay = document.getElementById('task-edit-timeofday').value;
  const daysActive = document.getElementById('task-edit-days').value;
  const repeatable = document.getElementById('task-edit-repeatable').value;
  const extraMode = document.getElementById('task-edit-extra-mode').value;

  // Auto-determine assignedTo for rotating/team extra tasks
  let finalAssignedTo = assignedTo;
  let finalExtraMode = extraMode;
  if (data.kids.length === 1) {
    // Single-kid families: force individual mode, assign to the only kid
    finalExtraMode = 'individual';
    finalAssignedTo = data.kids[0].id;
  } else if (type === 'extra') {
    if (extraMode === 'rotating') finalAssignedTo = 'shared';
    else if (extraMode === 'team') finalAssignedTo = 'both';
  }

  if (!title) return alert('Please enter a mission title.');

  if (id) {
    const t = data.tasks.find(x => x.id === id);
    if (t) {
      t.title = title; t.type = type; t.points = finalPoints;
      t.assignedTo = finalAssignedTo; t.requiresApproval = requiresApproval;
      t.timeOfDay = type === 'daily' ? timeOfDay : null;
      t.daysActive = type === 'daily' ? daysActive : null;
      t.repeatable = type === 'extra' ? repeatable : null;
      t.extraMode = type === 'extra' ? finalExtraMode : null;
    }
  } else {
    data.tasks.push({
      id: genId(), title, type, points: finalPoints, assignedTo: finalAssignedTo, requiresApproval,
      timeOfDay: type === 'daily' ? timeOfDay : null,
      daysActive: type === 'daily' ? daysActive : null,
      repeatable: type === 'extra' ? repeatable : null,
      extraMode: type === 'extra' ? finalExtraMode : null,
      claimedBy: null, completions: []
    });
  }

  saveData(data);
  closeModal('task-modal');
  renderParentTasks();
}

function deleteTask(taskId) {
  if (!confirm('Delete this mission?')) return;
  const data = getData();
  data.tasks = data.tasks.filter(t => t.id !== taskId);
  saveData(data);
  renderParentTasks();
}

// ============ PARENT REWARDS ============

function renderParentRewards() {
  const data = getData();
  const container = document.getElementById('parent-rewards');

  let html = `<button class="btn btn-green" onclick="openRewardModal()" style="margin-bottom:16px">+ Add Reward</button>`;
  html += '<div class="crud-list">';

  if (data.rewards.length === 0) {
    html += '<div class="empty-state"><span class="emoji">üéÅ</span>No rewards yet</div>';
  } else {
    html += data.rewards.map(r => `
      <div class="crud-item">
        <div style="font-size:2rem;margin-right:4px">${r.emoji}</div>
        <div class="info">
          <div class="label">${r.title}</div>
          <div class="meta">${r.cost} points</div>
        </div>
        <div class="actions">
          <button class="icon-btn edit" onclick="openRewardModal('${r.id}')">‚úèÔ∏è</button>
          <button class="icon-btn delete" onclick="deleteReward('${r.id}')">üóëÔ∏è</button>
        </div>
      </div>
    `).join('');
  }

  html += '</div>';
  container.innerHTML = html;
}

let selectedRewardEmoji = '‚≠ê';

function openRewardModal(rewardId) {
  const data = getData();
  document.getElementById('reward-edit-id').value = rewardId || '';
  document.getElementById('reward-modal-title').textContent = rewardId ? 'Edit Reward' : 'Add Reward';

  const grid = document.getElementById('reward-emoji-grid');
  grid.innerHTML = REWARD_EMOJIS.map(e =>
    `<div class="avatar-option" data-emoji="${e}" onclick="selectRewardEmoji(this)">${e}</div>`
  ).join('');

  if (rewardId) {
    const r = data.rewards.find(x => x.id === rewardId);
    if (!r) return;
    document.getElementById('reward-edit-title').value = r.title;
    document.getElementById('reward-edit-cost').value = r.cost;
    selectedRewardEmoji = r.emoji;
  } else {
    document.getElementById('reward-edit-title').value = '';
    document.getElementById('reward-edit-cost').value = 20;
    selectedRewardEmoji = '‚≠ê';
  }

  grid.querySelectorAll('.avatar-option').forEach(el => {
    el.classList.toggle('selected', el.dataset.emoji === selectedRewardEmoji);
  });

  document.getElementById('reward-modal').classList.add('show');
}

function selectRewardEmoji(el) {
  document.querySelectorAll('#reward-emoji-grid .avatar-option').forEach(a => a.classList.remove('selected'));
  el.classList.add('selected');
  selectedRewardEmoji = el.dataset.emoji;
}

function saveReward() {
  const data = getData();
  const id = document.getElementById('reward-edit-id').value;
  const title = document.getElementById('reward-edit-title').value.trim();
  const cost = parseInt(document.getElementById('reward-edit-cost').value) || 20;

  if (!title) return alert('Please enter a reward title.');

  if (id) {
    const r = data.rewards.find(x => x.id === id);
    if (r) { r.title = title; r.cost = cost; r.emoji = selectedRewardEmoji; }
  } else {
    data.rewards.push({ id: genId(), title, cost, emoji: selectedRewardEmoji });
  }

  saveData(data);
  closeModal('reward-modal');
  renderParentRewards();
}

function deleteReward(rewardId) {
  if (!confirm('Delete this reward?')) return;
  const data = getData();
  data.rewards = data.rewards.filter(r => r.id !== rewardId);
  saveData(data);
  renderParentRewards();
}

// ============ PARENT APPROVALS ============

function renderParentApprovals() {
  const data = getData();
  const container = document.getElementById('parent-approvals');
  const pending = [];
  const seenTeamTasks = new Set();

  data.kids.forEach(kid => {
    kid.completedTasks.forEach(ct => {
      if (!ct.approved) {
        const task = data.tasks.find(t => t.id === ct.taskId);
        if (task) {
          // Deduplicate team tasks ‚Äî show one entry for both kids
          if (isTeamTask(task)) {
            const key = `${ct.taskId}-${ct.date}`;
            if (seenTeamTasks.has(key)) return;
            seenTeamTasks.add(key);
            pending.push({ kid: null, task, ct, isTeam: true });
          } else {
            pending.push({ kid, task, ct, isTeam: false });
          }
        }
      }
    });
  });

  if (pending.length === 0) {
    container.innerHTML = '<div class="empty-state"><span class="emoji">‚úÖ</span>All missions verified!</div>';
    return;
  }

  container.innerHTML = pending.map(({ kid, task, ct, isTeam }) => {
    if (isTeam) {
      const kidNames = data.kids.map(k => k.name).join(' & ');
      return `<div class="approval-item">
        <div class="info">
          <div class="label">ü§ù Team: ${task.title}</div>
          <div class="meta">${ct.date} ¬∑ ${task.points} pts each to ${kidNames}</div>
        </div>
        <div class="actions">
          <button class="btn btn-green" style="padding:8px 14px;font-size:0.85rem;min-width:0" onclick="approveTask(null,'${task.id}','${ct.date}')">Approve</button>
          <button class="btn btn-pink" style="padding:8px 14px;font-size:0.85rem;min-width:0" onclick="rejectTask(null,'${task.id}','${ct.date}')">Reject</button>
        </div>
      </div>`;
    }
    return `<div class="approval-item">
      <div class="info">
        <div class="label">${renderAvatar(kid.avatar, 'small')} ${kid.name}: ${task.title}</div>
        <div class="meta">${ct.date} ¬∑ ${task.points} points</div>
      </div>
      <div class="actions">
        <button class="btn btn-green" style="padding:8px 14px;font-size:0.85rem;min-width:0" onclick="approveTask('${kid.id}','${task.id}','${ct.date}')">Approve</button>
        <button class="btn btn-pink" style="padding:8px 14px;font-size:0.85rem;min-width:0" onclick="rejectTask('${kid.id}','${task.id}','${ct.date}')">Reject</button>
      </div>
    </div>`;
  }).join('');
}

function approveTask(kidId, taskId, date) {
  const data = getData();
  const task = data.tasks.find(t => t.id === taskId);
  if (!task) return;

  // === TEAM APPROVAL: approve for ALL kids at once ===
  if (isTeamTask(task)) {
    data.kids.forEach(k => {
      const ct = k.completedTasks.find(c => c.taskId === taskId && c.date === date && !c.approved);
      if (ct) {
        ct.approved = true;
        k.points += task.points;
      }
    });
    // Handle extra one-time removal
    if (task.type === 'extra') {
      const rep = task.repeatable || 'once';
      if (rep === 'once') {
        data.tasks = data.tasks.filter(t => t.id !== taskId);
      }
    }
    saveData(data);
    renderParentApprovals();
    return;
  }

  // === STANDARD APPROVAL ===
  const kid = data.kids.find(k => k.id === kidId);
  if (!kid) return;

  const ct = kid.completedTasks.find(c => c.taskId === taskId && c.date === date && !c.approved);
  if (ct) {
    ct.approved = true;
    kid.points += task.points;
  }

  // Handle extra task repeatable behavior after approval
  if (task.type === 'extra') {
    const rep = task.repeatable || 'once';
    if (rep === 'once') {
      data.tasks = data.tasks.filter(t => t.id !== taskId);
    } else {
      task.claimedBy = null;
    }
    // Track last completed by for rotating tasks
    if (getExtraMode(task) === 'rotating') {
      task.lastCompletedBy = kidId;
    }
  }

  saveData(data);
  renderParentApprovals();
}

function rejectTask(kidId, taskId, date) {
  const data = getData();
  const task = data.tasks.find(t => t.id === taskId);
  if (!task) return;

  // === TEAM REJECTION: reject for ALL kids at once ===
  if (isTeamTask(task)) {
    data.kids.forEach(k => {
      k.completedTasks = k.completedTasks.filter(c => !(c.taskId === taskId && c.date === date && !c.approved));
    });
    task.completions = task.completions.filter(c => !(c.date === date));
    saveData(data);
    renderParentApprovals();
    return;
  }

  // === STANDARD REJECTION ===
  const kid = data.kids.find(k => k.id === kidId);
  if (!kid) return;

  kid.completedTasks = kid.completedTasks.filter(c => !(c.taskId === taskId && c.date === date && !c.approved));
  task.completions = task.completions.filter(c => !(c.kidId === kidId && c.date === date));
  if (task.type === 'extra' && task.claimedBy === kidId) {
    task.claimedBy = null;
  }

  saveData(data);
  renderParentApprovals();
}

// ============ PARENT HISTORY ============

function renderParentHistory() {
  const data = getData();
  const container = document.getElementById('parent-history');
  const redemptions = data.redemptions || [];

  if (redemptions.length === 0) {
    container.innerHTML = '<div class="empty-state"><span class="emoji">üéÅ</span>No rewards redeemed yet!</div>';
    return;
  }

  // Sort by date descending (most recent first)
  const sorted = [...redemptions].sort((a, b) => b.date.localeCompare(a.date));

  let html = '<div class="crud-list">';
  html += sorted.map(r => {
    const kid = data.kids.find(k => k.id === r.kidId);
    const reward = data.rewards.find(rw => rw.id === r.rewardId);
    const kidName = kid ? kid.name : 'Unknown';
    const kidAvatar = kid ? renderAvatar(kid.avatar, 'small') : '';
    const rewardTitle = reward ? reward.title : 'Deleted reward';
    const rewardEmoji = reward ? reward.emoji : 'üéÅ';
    const cost = reward ? reward.cost : '?';

    return `<div class="crud-item">
      <div style="font-size:1.8rem;margin-right:4px">${rewardEmoji}</div>
      <div class="info">
        <div class="label">${rewardTitle}</div>
        <div class="meta">${kidAvatar} ${kidName} ¬∑ ${r.date} ¬∑ ${cost} pts</div>
      </div>
    </div>`;
  }).join('');
  html += '</div>';

  container.innerHTML = html;
}

// ============ BONUS POINTS ============

function openBonusModal(kidId) {
  const data = getData();
  const kid = data.kids.find(k => k.id === kidId);
  if (!kid) return;
  document.getElementById('bonus-kid-id').value = kidId;
  document.getElementById('bonus-kid-name').textContent = kid.name;
  document.getElementById('bonus-points').value = 5;
  document.getElementById('bonus-reason').value = '';
  document.getElementById('bonus-modal').classList.add('show');
}

function grantBonusPoints() {
  const kidId = document.getElementById('bonus-kid-id').value;
  const points = parseInt(document.getElementById('bonus-points').value) || 0;
  const reason = document.getElementById('bonus-reason').value.trim();
  if (points < 1) return;
  if (!reason) { document.getElementById('bonus-reason').focus(); return; }

  const data = getData();
  const kid = data.kids.find(k => k.id === kidId);
  if (!kid) return;

  kid.points += points;
  if (!data.bonusGrants) data.bonusGrants = [];
  data.bonusGrants.push({
    id: genId(),
    kidId: kidId,
    points: points,
    reason: reason,
    date: getToday()
  });

  saveData(data);
  closeModal('bonus-modal');
  showCelebration(`+${points} ‚≠ê`);
  triggerConfetti();
  renderParentOverview();
}

// ============ DEDUCT POINTS ============

function openDeductModal(kidId) {
  const data = getData();
  const kid = data.kids.find(k => k.id === kidId);
  if (!kid) return;
  document.getElementById('deduct-kid-id').value = kidId;
  document.getElementById('deduct-kid-name').textContent = kid.name;
  document.getElementById('deduct-points').value = 5;
  document.getElementById('deduct-reason').value = '';
  document.getElementById('deduct-modal').classList.add('show');
}

function deductPoints() {
  const kidId = document.getElementById('deduct-kid-id').value;
  const points = parseInt(document.getElementById('deduct-points').value) || 0;
  const reason = document.getElementById('deduct-reason').value.trim();
  if (points < 1) return;
  if (!reason) { document.getElementById('deduct-reason').focus(); return; }

  const data = getData();
  const kid = data.kids.find(k => k.id === kidId);
  if (!kid) return;

  kid.points = Math.max(0, kid.points - points);
  if (!data.bonusGrants) data.bonusGrants = [];
  data.bonusGrants.push({
    id: genId(),
    kidId: kidId,
    points: -points,
    reason: reason,
    date: getToday()
  });

  saveData(data);
  closeModal('deduct-modal');
  renderParentOverview();
}

// ============ MANAGE KIDS ============

let addKidPhoto = null;

function openAddKidModal() {
  addKidPhoto = null;
  document.getElementById('add-kid-name').value = '';
  const preview = document.getElementById('add-kid-preview');
  preview.classList.remove('show');
  preview.removeAttribute('src');
  const grid = document.getElementById('add-kid-avatars');
  grid.innerHTML = AVATARS.map(a =>
    `<div class="avatar-option" data-avatar="${a}" onclick="selectAddKidAvatar(this)">${a}</div>`
  ).join('');
  document.getElementById('add-kid-modal').classList.add('show');
}

function selectAddKidAvatar(el) {
  document.querySelectorAll('#add-kid-avatars .avatar-option').forEach(a => a.classList.remove('selected'));
  el.classList.add('selected');
  addKidPhoto = null;
  document.getElementById('add-kid-preview').classList.remove('show');
}

function handleAddKidPhoto(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      canvas.width = 128; canvas.height = 128;
      const ctx = canvas.getContext('2d');
      const s = Math.min(img.width, img.height);
      ctx.drawImage(img, (img.width-s)/2, (img.height-s)/2, s, s, 0, 0, 128, 128);
      addKidPhoto = canvas.toDataURL('image/jpeg', 0.8);
      const preview = document.getElementById('add-kid-preview');
      preview.src = addKidPhoto;
      preview.classList.add('show');
      document.querySelectorAll('#add-kid-avatars .avatar-option').forEach(a => a.classList.remove('selected'));
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function addNewKid() {
  const name = document.getElementById('add-kid-name').value.trim();
  const av = document.querySelector('#add-kid-avatars .selected');
  if (!name) return alert('Please enter a name for the new agent.');
  if (!addKidPhoto && !av) return alert('Please pick an avatar or upload a photo.');

  const avatar = addKidPhoto || av.dataset.avatar;
  const data = getData();
  data.kids.push({ id: genId(), name: name, avatar: avatar, points: 0, completedTasks: [] });
  saveData(data);
  closeModal('add-kid-modal');
  renderParentOverview();
}

function removeKid(kidId) {
  const data = getData();
  const kid = data.kids.find(k => k.id === kidId);
  if (!kid) return;
  if (data.kids.length <= 1) return alert('You need at least one agent.');
  if (!confirm(`Remove ${kid.name}? This will delete all their points and history.`)) return;

  data.kids = data.kids.filter(k => k.id !== kidId);
  // Reassign tasks that were assigned to this kid
  data.tasks.forEach(t => {
    if (t.assignedTo === kidId) t.assignedTo = 'both';
  });
  // Clean up completions and redemptions referencing this kid
  data.tasks.forEach(t => {
    t.completions = t.completions.filter(c => c.kidId !== kidId);
  });
  if (data.redemptions) data.redemptions = data.redemptions.filter(r => r.kidId !== kidId);
  if (data.bonusGrants) data.bonusGrants = data.bonusGrants.filter(b => b.kidId !== kidId);

  saveData(data);
  renderParentOverview();
}

// ============ MODALS ============

function closeModal(id) {
  document.getElementById(id).classList.remove('show');
}

document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) overlay.classList.remove('show');
  });
});

// ============ ANIMATIONS ============

function triggerConfetti() {
  const container = document.getElementById('confetti-container');
  const colors = ['#FFD93D', '#FF6B9D', '#6BCB77', '#4D96FF', '#9B59B6', '#FF8C42'];
  for (let i = 0; i < 40; i++) {
    const piece = document.createElement('div');
    piece.className = 'confetti-piece';
    piece.style.left = Math.random() * 100 + '%';
    piece.style.background = colors[Math.floor(Math.random() * colors.length)];
    piece.style.animationDelay = Math.random() * 0.5 + 's';
    piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
    piece.style.width = (Math.random() * 8 + 6) + 'px';
    piece.style.height = (Math.random() * 8 + 6) + 'px';
    container.appendChild(piece);
  }
  setTimeout(() => { container.innerHTML = ''; }, 2000);
}

function showCelebration(text) {
  const el = document.createElement('div');
  el.className = 'celebration';
  el.textContent = text;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1000);

  document.querySelectorAll('.points-badge').forEach(b => {
    b.classList.remove('points-anim');
    void b.offsetWidth;
    b.classList.add('points-anim');
  });
}

// ============ INIT ============

initApp();
</script>
</body>
</html>
